<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VelmistrÅ¯v Panel â€“ PivnÃ­ Dungeon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Cinzel:wght@400;700&display=swap');
        :root { --bg: #0d0a14; --card: rgba(22,14,32,0.97); --border: #8b4513; --accent: #f6e05e; }
        body { background: var(--bg); color: #eee; font-family: 'Cinzel', serif; min-height: 100vh; }
        .fantasy-font { font-family: 'Bangers', cursive; text-shadow: 2px 2px 6px #000; letter-spacing: 2px; }
        .glass-card { background: var(--card); border: 1px solid rgba(139,69,19,0.6); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); }
        .hidden { display: none !important; }
        input { background: rgba(0,0,0,0.7); border: 1px solid rgba(139,69,19,0.5); border-radius: 8px; color: #fff; font-family: 'Cinzel', serif; outline: none; }
        .btn { border-radius: 8px; font-family: 'Cinzel', serif; font-weight: 700; cursor: pointer; transition: filter 0.2s; border: none; }
        .btn:hover { filter: brightness(1.15); }
        .btn-green { background: linear-gradient(135deg, #276749, #1a4731); color: #fff; border: 1px solid #2f7a54; }
        .btn-red   { background: linear-gradient(135deg, #9b2c2c, #6b1f1f); color: #fff; border: 1px solid #c53030; }
        .btn-blue  { background: linear-gradient(135deg, #2b5fa0, #1a3a6b); color: #fff; border: 1px solid #3b7dd8; }
        .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #2d3748; color: #fff; padding: 10px 20px; border-radius: 10px; z-index: 9999; font-size: 0.85rem; border: 1px solid #8b4513; transition: opacity 0.3s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease forwards; }
    </style>
</head>
<body class="p-4 flex flex-col items-center">

    <!-- PÅ™ihlaÅ¡ovacÃ­ formulÃ¡Å™ -->
    <div id="login-screen" class="w-full max-w-sm mt-16">
        <h1 class="text-4xl mb-6 text-yellow-500 fantasy-font text-center">âš”ï¸ VELMISTRÅ®V PANEL âš”ï¸</h1>
        <div class="glass-card p-6">
            <p class="text-orange-400 text-sm mb-4 text-center">PÅ™Ã­stup jen pro velmistra</p>
            <input id="admin-email"    type="email"    placeholder="E-mail" class="w-full p-3 mb-3">
            <input id="admin-password" type="password" placeholder="Heslo"  class="w-full p-3 mb-4">
            <button id="btn-admin-login" class="btn btn-blue w-full py-3 uppercase text-sm">Vstoupit do panelu</button>
            <div id="login-error" class="text-red-400 text-xs mt-3 text-center font-bold"></div>
        </div>
    </div>

    <!-- HlavnÃ­ panel -->
    <div id="admin-panel" class="hidden w-full max-w-3xl">
        <div class="flex justify-between items-center my-6">
            <h1 class="text-4xl text-yellow-500 fantasy-font">âš”ï¸ VELMISTRÅ®V PANEL âš”ï¸</h1>
            <div class="text-right">
                <div id="admin-info" class="text-xs text-gray-400 mb-1"></div>
                <button id="btn-admin-logout" class="text-red-500 text-xs underline">OdhlÃ¡sit</button>
            </div>
        </div>

        <!-- SchvalovÃ¡nÃ­ piv -->
        <div class="glass-card p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl text-orange-400 font-bold uppercase tracking-wide">ğŸ“œ NÃ¡vrhy piv ke schvÃ¡lenÃ­</h2>
                <button id="btn-refresh" class="btn btn-blue px-4 py-2 text-xs uppercase">â†» Obnovit</button>
            </div>
            <div id="seznam-navrhu" class="space-y-3">
                <p class="text-gray-500 italic text-sm text-center py-4">NaÄÃ­tÃ¡m...</p>
            </div>
        </div>

        <!-- SprÃ¡va vÃ¡leÄnÃ½ch zÃ¡znamÅ¯ -->
        <div class="glass-card p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl text-orange-400 font-bold uppercase tracking-wide">âš”ï¸ AktivnÃ­ cechovnÃ­ vÃ¡lky</h2>
                <button id="btn-refresh-valky" class="btn btn-blue px-4 py-2 text-xs uppercase">â†» Obnovit</button>
            </div>
            <div id="seznam-valek" class="space-y-3">
                <p class="text-gray-500 italic text-sm text-center py-4">NaÄÃ­tÃ¡m...</p>
            </div>
        </div>

        <!-- Å½ebÅ™Ã­Äek hrÃ¡ÄÅ¯ -->
        <div class="glass-card p-6 mb-6">
            <h2 class="text-xl text-orange-400 font-bold uppercase tracking-wide mb-4">ğŸ† Top hrÃ¡Äi (XP)</h2>
            <div id="zebricek-hracu" class="space-y-1 text-sm"></div>
        </div>


        <!-- ğŸ—‘ï¸ MazÃ¡nÃ­ piv hrÃ¡Äe -->
        <div class="glass-card p-6 mb-6 border border-red-900">
            <h2 class="text-xl text-red-400 font-bold uppercase tracking-wide mb-1">ğŸ—‘ï¸ SprÃ¡va zÃ¡pisÅ¯ hrÃ¡Äe</h2>
            <p class="text-xs text-gray-500 mb-4">Vyhledej hrÃ¡Äe a smaÅ¾ mu konkrÃ©tnÃ­ zÃ¡znamy (podvÃ¡dÄ›nÃ­ apod.).</p>

            <div class="flex gap-2 mb-4">
                <input id="admin-hrac-email" type="email" placeholder="E-mail hrÃ¡Äe..." class="flex-grow p-2 text-sm bg-black bg-opacity-70 border border-gray-700 rounded text-white font-mono">
                <button id="btn-hledat-hrace" class="btn btn-blue px-4 py-2 text-xs uppercase flex-shrink-0">ğŸ” Hledat</button>
            </div>

            <div id="admin-hrac-info" class="hidden mb-3 bg-black bg-opacity-50 rounded p-3 text-sm border border-gray-700">
                <span class="text-yellow-400 font-bold" id="admin-hrac-prezdivka">â€”</span>
                <span class="text-gray-400 ml-2" id="admin-hrac-xp">0 XP</span>
                <span class="text-gray-600 ml-2 text-xs" id="admin-hrac-uid"></span>
            </div>

            <div id="admin-logy-box" class="hidden">
                <div class="text-xs text-gray-400 uppercase font-bold mb-2">PoslednÃ­ch 50 zÃ¡pisÅ¯</div>
                <div id="admin-logy-seznam" class="space-y-1 max-h-96 overflow-y-auto bg-black bg-opacity-40 rounded p-2 border border-gray-800"></div>
            </div>
            <div id="admin-logy-loading" class="hidden text-gray-500 italic text-sm text-center py-4">NaÄÃ­tÃ¡m...</div>
        </div>

        <!-- Migrace databÃ¡ze -->
        <div class="glass-card p-6 mb-6 border border-yellow-900">
            <h2 class="text-xl text-yellow-500 font-bold uppercase tracking-wide mb-1">ğŸ”§ SprÃ¡va & Migrace</h2>
            <p class="text-xs text-gray-500 mb-5">NÃ¡stroje pro ÃºdrÅ¾bu databÃ¡ze. SpouÅ¡tÄ›j jen kdyÅ¾ vÃ­Å¡ co dÄ›lÃ¡Å¡.</p>

            <div class="space-y-4">

                <!-- Migrace statistik -->
                <div class="bg-black bg-opacity-50 rounded-lg p-4 border border-gray-700">
                    <div class="flex justify-between items-start gap-4">
                        <div>
                            <div class="text-sm font-bold text-orange-300 mb-1">ğŸ“Š PÅ™epoÄÃ­tat statistiky piv & hospod</div>
                            <div class="text-xs text-gray-400">Projde logy vÅ¡ech hrÃ¡ÄÅ¯ a znovu sestavÃ­ <code class="text-yellow-600">statistiky_piv</code> a <code class="text-yellow-600">statistiky_hospod</code>. NutnÃ© po pÅ™idÃ¡nÃ­ SÃ­nÄ› slÃ¡vy.</div>
                        </div>
                        <button id="btn-migrace-statistiky" class="btn btn-blue px-4 py-2 text-xs uppercase flex-shrink-0">Spustit</button>
                    </div>
                    <div id="migrace-statistiky-log" class="hidden mt-3 bg-black rounded p-3 text-xs text-green-400 font-mono max-h-40 overflow-y-auto"></div>
                </div>

                <!-- Migrace schÃ©mat hrÃ¡ÄÅ¯ -->
                <div class="bg-black bg-opacity-50 rounded-lg p-4 border border-gray-700">
                    <div class="flex justify-between items-start gap-4">
                        <div>
                            <div class="text-sm font-bold text-orange-300 mb-1">ğŸ‘¤ Doplnit chybÄ›jÃ­cÃ­ pole hrÃ¡ÄÅ¯</div>
                            <div class="text-xs text-gray-400">Projde vÅ¡echny hrÃ¡Äe a doplnÃ­ novÃ¡ pole kterÃ¡ jim chybÃ­ (<code class="text-yellow-600">cech_zakladatel</code>, <code class="text-yellow-600">verze_schematu</code> atd.). OdstranÃ­ rozdÃ­l mezi starÃ½mi a novÃ½mi ÃºÄty.</div>
                        </div>
                        <button id="btn-migrace-hraci" class="btn btn-blue px-4 py-2 text-xs uppercase flex-shrink-0">Spustit</button>
                    </div>
                    <div id="migrace-hraci-log" class="hidden mt-3 bg-black rounded p-3 text-xs text-green-400 font-mono max-h-40 overflow-y-auto"></div>
                </div>

                <!-- Reset krajovÃ© vÃ¡lky -->
                <div class="bg-black bg-opacity-50 rounded-lg p-4 border border-gray-700">
                    <div class="flex justify-between items-start gap-4">
                        <div>
                            <div class="text-sm font-bold text-orange-300 mb-1">ğŸ‘‘ RuÄnÃ­ reset KrÃ¡lovstvÃ­</div>
                            <div class="text-xs text-gray-400">SmaÅ¾e vÃ½sledky aktuÃ¡lnÃ­ho mÄ›sÃ­ce z kolekcÃ­ <code class="text-yellow-600">kralovstvi</code> a <code class="text-yellow-600">kralovstvi_hraci</code>. Reset jinak probÃ­hÃ¡ automaticky kaÅ¾dÃ½ mÄ›sÃ­c.</div>
                        </div>
                        <button id="btn-reset-kralovstvi" class="btn btn-red px-4 py-2 text-xs uppercase flex-shrink-0">Reset</button>
                    </div>
                    <div id="reset-kralovstvi-log" class="hidden mt-3 bg-black rounded p-3 text-xs text-green-400 font-mono max-h-40 overflow-y-auto"></div>
                </div>

                <!-- SpÃ¡rovÃ¡nÃ­ spoleÄnÃ©ho pitÃ­ -->
                <div class="bg-black bg-opacity-50 rounded-lg p-4 border border-gray-700">
                    <div class="flex justify-between items-start gap-4">
                        <div>
                            <div class="text-sm font-bold text-orange-300 mb-1">ğŸ» SpÃ¡rovat zÃ¡znamy spoleÄnÃ©ho pitÃ­</div>
                            <div class="text-xs text-gray-400">Projde logy vÅ¡ech hrÃ¡ÄÅ¯ a zpÄ›tnÄ› spÃ¡ruje zÃ¡znamy ze stejnÃ© hospody do 5 minut od sebe. DoplnÃ­ pole <code class="text-yellow-600">spolecne_s</code> u historickÃ½ch zÃ¡znamÅ¯.</div>
                        </div>
                        <button id="btn-migrace-spolecne" class="btn btn-blue px-4 py-2 text-xs uppercase flex-shrink-0">Spustit</button>
                    </div>
                    <div id="migrace-spolecne-log" class="hidden mt-3 bg-black rounded p-3 text-xs text-green-400 font-mono max-h-40 overflow-y-auto"></div>
                </div>

                <!-- Reset statistik -->
                <div class="bg-black bg-opacity-50 rounded-lg p-4 border border-red-900">
                    <div class="flex justify-between items-start gap-4">
                        <div>
                            <div class="text-sm font-bold text-red-400 mb-1">ğŸ—‘ï¸ Vymazat a pÅ™epoÄÃ­tat statistiky</div>
                            <div class="text-xs text-gray-400">SmaÅ¾e <code class="text-yellow-600">statistiky_piv</code> a <code class="text-yellow-600">statistiky_hospod</code> a sestavÃ­ je od nuly. PouÅ¾ij pokud jsou data poÅ¡kozenÃ¡ nebo zduplikovanÃ¡.</div>
                        </div>
                        <button id="btn-reset-statistiky" class="btn btn-red px-4 py-2 text-xs uppercase flex-shrink-0">Reset</button>
                    </div>
                    <div id="reset-statistiky-log" class="hidden mt-3 bg-black rounded p-3 text-xs text-green-400 font-mono max-h-40 overflow-y-auto"></div>
                </div>

            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
            from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, collectionGroup, getDocs, doc, deleteDoc, updateDoc,
                 increment, addDoc, getDoc, setDoc, query, orderBy, limit, writeBatch, where, Timestamp }
            from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const firebaseConfig = {
            apiKey: "AIzaSyCrtK_99uh1SGyj2KhA2ljH3aAhynDnhqI",
            authDomain: "pivnidungeon.firebaseapp.com",
            projectId: "pivnidungeon",
            storageBucket: "pivnidungeon.firebasestorage.app",
            messagingSenderId: "174543526039",
            appId: "1:174543526039:web:be6092c458e376c306b1d2"
        };

        // â”€â”€â”€ SEZNAM ADMIN UID (pÅ™idej svÃ¡ UID sem) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Jak zÃ­skat UID: pÅ™ihlas se do Firebase console â†’ Authentication â†’ Users
        const ADMIN_UIDS = [
            // "VLOZ_SEM_SVUJ_FIREBASE_UID_1",
            // "VLOZ_SEM_SVUJ_FIREBASE_UID_2",
        ];

        const app  = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db   = getFirestore(app);

        // â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function $(id) { return document.getElementById(id); }
        function show(id) { $(id).classList.remove('hidden'); }
        function hide(id) { $(id).classList.add('hidden'); }

        function notify(msg, color = '#2d3748') {
            const t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            t.style.background = color;
            document.body.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
        }

        // â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                show('login-screen');
                hide('admin-panel');
                return;
            }

            // Pokud je seznam ADMIN_UIDS prÃ¡zdnÃ½, povolÃ­me kohokoli (dev mode)
            if (ADMIN_UIDS.length > 0 && !ADMIN_UIDS.includes(user.uid)) {
                notify('â›” NemÃ¡Å¡ pÅ™Ã­stup do velmistrova panelu!', '#7b341e');
                await signOut(auth);
                return;
            }

            hide('login-screen');
            show('admin-panel');
            $('admin-info').textContent = `PÅ™ihlÃ¡Å¡en: ${user.email}`;
            await Promise.all([nactiNavrhy(), nactiValky(), nactiZebricek()]);
        });

        $('btn-admin-login').addEventListener('click', async () => {
            const email = $('admin-email').value.trim();
            const pass  = $('admin-password').value;
            $('login-error').textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch(e) {
                $('login-error').textContent = 'NesprÃ¡vnÃ© pÅ™ihlaÅ¡ovacÃ­ Ãºdaje.';
            }
        });

        $('btn-admin-logout').addEventListener('click', () => signOut(auth));

        $('btn-refresh').addEventListener('click', nactiNavrhy);
        $('btn-refresh-valky').addEventListener('click', nactiValky);

        // â”€â”€â”€ NÃVRHY PIV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function nactiNavrhy() {
            const list = $('seznam-navrhu');
            list.innerHTML = '<p class="text-gray-500 italic text-sm text-center py-4">NaÄÃ­tÃ¡m nÃ¡vrhy...</p>';

            const snap = await getDocs(collection(db, "navrhy_piv"));

            if (snap.empty) {
                list.innerHTML = '<p class="text-green-500 text-sm text-center py-4">âœ“ Å½Ã¡dnÃ© ÄekajÃ­cÃ­ nÃ¡vrhy. Sudy jsou v poÅ™Ã¡dku.</p>';
                return;
            }

            list.innerHTML = '';
            snap.forEach(d => {
                const p = d.data();
                const card = document.createElement('div');
                card.className = 'bg-black bg-opacity-60 p-4 rounded-lg border border-gray-700 flex justify-between items-center fade-in';

                const info = document.createElement('div');
                info.innerHTML = `
                    <div class="text-yellow-400 font-bold text-base">${escapeHtml(p.nazev_piva)}</div>
                    <div class="text-xs text-gray-400 mt-1">
                        Navrhl: <span class="text-orange-400">${escapeHtml(p.navrhl ?? 'â€”')}</span>
                        &nbsp;Â·&nbsp; Hospoda: <span class="text-gray-300">${escapeHtml(p.hospoda ?? 'â€”')}</span>
                    </div>
                `;

                const btns = document.createElement('div');
                btns.className = 'flex gap-2 ml-4 flex-shrink-0';

                const btnSchvalit = document.createElement('button');
                btnSchvalit.className = 'btn btn-green px-4 py-2 text-xs uppercase';
                btnSchvalit.textContent = 'âœ“ SchvÃ¡lit';
                btnSchvalit.addEventListener('click', () => schvalit(d.id, p));

                const btnZamitnout = document.createElement('button');
                btnZamitnout.className = 'btn btn-red px-3 py-2 text-xs uppercase';
                btnZamitnout.textContent = 'âœ•';
                btnZamitnout.addEventListener('click', () => zamitnout(d.id, p.nazev_piva));

                btns.appendChild(btnSchvalit);
                btns.appendChild(btnZamitnout);
                card.appendChild(info);
                card.appendChild(btns);
                list.appendChild(card);
            });
        }

        async function schvalit(id, navrh) {
            const nazev = navrh.nazev_piva;
            const hracUid = navrh.navrhl_uid;
            const hospoda = navrh.hospoda || 'NezadÃ¡no';
            const casNavrhu = navrh.cas || null; // Timestamp z odeslÃ¡nÃ­ nÃ¡vrhu = Äas pitÃ­

            try {
                const batch = writeBatch(db);

                // 1. PÅ™idat pivo do globÃ¡lnÃ­ databÃ¡ze
                const pivRef = doc(collection(db, "vsechna_piva"));
                batch.set(pivRef, { nazev });

                // 2. OdmÄ›nit hrÃ¡Äe + zapsat log + dungeony (jen pokud UID existuje)
                if (hracUid) {
                    const hracRef = doc(db, "hraci", hracUid);
                    const hracSnap = await getDoc(hracRef);
                    if (hracSnap.exists()) {
                        // XP + dungeony
                        const bezTecky = hospoda.replace(/\./g, '_');
                        batch.update(hracRef, {
                            xp: increment(100),
                            [`dungeony.${bezTecky}`]: increment(1)
                        });

                        // Log_piv zÃ¡znam s pÅ¯vodnÃ­m Äasem odeslÃ¡nÃ­ nÃ¡vrhu
                        const logRef = doc(collection(db, "hraci", hracUid, "log_piv"));
                        batch.set(logRef, {
                            pivo: nazev,
                            hospoda: hospoda,
                            cas: casNavrhu,          // datum kdy hrÃ¡Ä pivo pil (odeslal nÃ¡vrh)
                            schvaleno: true          // oznaÄenÃ­ Å¾e jde o schvÃ¡lenÃ½ nÃ¡vrh
                        });
                    }
                }

                // 3. Smazat nÃ¡vrh
                batch.delete(doc(db, "navrhy_piv", id));

                await batch.commit();

                // 4. GlobÃ¡lnÃ­ statistiky (mimo batch â€” increment nefunguje v batch.set)
                if (hracUid) {
                    try {
                        await setDoc(doc(db, "statistiky_piv", nazev), { pocet: increment(1) }, { merge: true });
                    } catch(e) {
                        await setDoc(doc(db, "statistiky_piv", nazev), { pocet: 1 });
                    }
                    const bezTecky = hospoda.replace(/\./g, '_');
                    try {
                        await setDoc(doc(db, "statistiky_hospod", bezTecky), { pocet: increment(1), nazev: hospoda }, { merge: true });
                    } catch(e) {
                        await setDoc(doc(db, "statistiky_hospod", bezTecky), { pocet: 1, nazev: hospoda });
                    }
                }

                notify(`âœ“ Mok "${nazev}" pÅ™idÃ¡n! Hrdina odmÄ›nÄ›n +100 XP a zÃ¡znam zapsÃ¡n do denÃ­Äku s pÅ¯vodnÃ­m datem.`, '#276749');
                nactiNavrhy();
            } catch (e) { notify('Chyba: ' + e.message, '#9b2c2c'); }
        }

        async function zamitnout(id, nazev) {
            if (!confirm(`Opravdu zamÃ­tnout nÃ¡vrh "${nazev}"?`)) return;
            try {
                await deleteDoc(doc(db, "navrhy_piv", id));
                notify(`âœ• NÃ¡vrh "${nazev}" zamÃ­tnut.`);
                nactiNavrhy();
            } catch (e) { notify('Chyba: ' + e.message, '#9b2c2c'); }
        }

        // â”€â”€â”€ VÃLEÄŒNÃ‰ ZÃZNAMY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function nactiValky() {
            const box = $('seznam-valek');
            box.innerHTML = '<p class="text-gray-500 italic text-sm text-center py-4">NaÄÃ­tÃ¡m...</p>';

            const snap = await getDocs(collection(db, "valky"));

            if (snap.empty) {
                box.innerHTML = '<p class="text-gray-500 italic text-sm text-center py-4">Å½Ã¡dnÃ© zÃ¡znamy o vÃ¡lkÃ¡ch.</p>';
                return;
            }

            box.innerHTML = '';
            for (const d of snap.docs) {
                const v = d.data();

                const [uSnap, oSnap] = await Promise.all([
                    getDoc(doc(db, "cechy", v.utocnik_id)),
                    getDoc(doc(db, "cechy", v.obrance_id))
                ]);
                const uNazev = uSnap.exists() ? uSnap.data().nazev : 'ZruÅ¡enÃ½ cech';
                const oNazev = oSnap.exists() ? oSnap.data().nazev : 'ZruÅ¡enÃ½ cech';

                const stavBadge = {
                    'aktivni': '<span class="text-green-400 font-bold">ğŸ”¥ AktivnÃ­</span>',
                    'ceka':    '<span class="text-yellow-400 font-bold">â³ ÄŒekÃ¡ na pÅ™ijetÃ­</span>',
                    'skoncila':'<span class="text-gray-400">âœ“ UkonÄena</span>'
                }[v.stav] ?? v.stav;

                const card = document.createElement('div');
                card.className = 'bg-black bg-opacity-60 p-4 rounded-lg border border-orange-900 fade-in';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-orange-300 font-bold text-sm mb-1">
                                ${escapeHtml(uNazev)} <span class="text-gray-500">âš”ï¸</span> ${escapeHtml(oNazev)}
                            </div>
                            <div class="text-xs text-gray-400">Stav: ${stavBadge}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                SkÃ³re: <span class="text-yellow-400">${v.utocnik_bodu ?? 0}</span>
                                 : <span class="text-red-400">${v.obrance_bodu ?? 0}</span>
                                (cÃ­l: ${v.cil_bodu ?? 50})
                            </div>
                        </div>
                        ${v.stav !== 'skoncila' ? `
                        <button class="btn btn-red px-3 py-1 text-xs uppercase" data-vid="${d.id}">UkonÄit</button>
                        ` : ''}
                    </div>
                `;

                const delBtn = card.querySelector('[data-vid]');
                if (delBtn) {
                    delBtn.addEventListener('click', async () => {
                        if (!confirm('UkonÄit a smazat tuto vÃ¡lku?')) return;
                        await deleteDoc(doc(db, "valky", d.id));
                        notify('VÃ¡lka ukonÄena.');
                        nactiValky();
                    });
                }

                box.appendChild(card);
            }
        }

        // â”€â”€â”€ Å½EBÅ˜ÃÄŒEK HRÃÄŒÅ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function nactiZebricek() {
            const q = query(collection(db, "hraci"), orderBy("xp", "desc"), limit(20));
            const snap = await getDocs(q);
            $('zebricek-hracu').innerHTML = snap.docs.map((d, i) => {
                const h = d.data();
                const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i+1}.`;
                return `<div class="flex justify-between items-center border-b border-gray-800 py-1">
                    <span>${medal} <span class="text-yellow-400">${escapeHtml(h.prezdivka ?? h.email ?? 'â€”')}</span></span>
                    <span class="text-yellow-500 text-xs">${h.xp ?? 0} XP</span>
                </div>`;
            }).join('') || '<div class="text-gray-600 text-sm">Å½Ã¡dnÃ­ hrÃ¡Äi.</div>';
        }

        // â”€â”€â”€ MAZÃNÃ ZÃPISÅ® HRÃÄŒE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let adminVybranyHracUid = null;

        document.getElementById('btn-hledat-hrace').addEventListener('click', async () => {
            const email = document.getElementById('admin-hrac-email').value.trim().toLowerCase();
            if (!email) { notify('Zadej e-mail hrÃ¡Äe!'); return; }

            document.getElementById('admin-hrac-info').classList.add('hidden');
            document.getElementById('admin-logy-box').classList.add('hidden');
            document.getElementById('admin-logy-loading').classList.remove('hidden');

            try {
                const q = query(collection(db, "hraci"), where("email", "==", email));
                const snap = await getDocs(q);
                if (snap.empty) { notify('HrÃ¡Ä s tÃ­mto e-mailem nenalezen.'); document.getElementById('admin-logy-loading').classList.add('hidden'); return; }

                const d = snap.docs[0];
                const h = d.data();
                adminVybranyHracUid = d.id;

                document.getElementById('admin-hrac-prezdivka').textContent = h.prezdivka || 'â€”';
                document.getElementById('admin-hrac-xp').textContent = (h.xp || 0) + ' XP';
                document.getElementById('admin-hrac-uid').textContent = d.id;
                document.getElementById('admin-hrac-info').classList.remove('hidden');

                // NaÄti logy
                const logySnap = await getDocs(query(
                    collection(db, "hraci", d.id, "log_piv"),
                    orderBy("cas", "desc"),
                    limit(50)
                ));

                const seznam = document.getElementById('admin-logy-seznam');
                if (logySnap.empty) {
                    seznam.innerHTML = '<div class="text-gray-600 italic text-xs text-center py-3">Å½Ã¡dnÃ© zÃ¡znamy.</div>';
                } else {
                    seznam.innerHTML = logySnap.docs.map(ld => {
                        const z = ld.data();
                        const casObj = z.cas?.toDate ? z.cas.toDate() : null;
                        const datum = casObj ? casObj.toLocaleDateString('cs-CZ') + ' ' + casObj.toLocaleTimeString('cs-CZ', {hour:'2-digit',minute:'2-digit'}) : 'â€”';
                        return `<div class="flex justify-between items-center border-b border-gray-800 py-1 text-xs" id="logrow-${ld.id}">
                            <span>
                                <span class="text-yellow-400 font-bold">${escapeHtml(z.pivo || 'â€”')}</span>
                                <span class="text-gray-400"> @ ${escapeHtml(z.hospoda || 'â€”')}</span>
                                <span class="text-gray-600 ml-1">${datum}</span>
                            </span>
                            <button onclick="adminSmazatZapis('${ld.id}', '${escapeHtml(z.pivo||'')}', '${escapeHtml(z.hospoda||'')}')"
                                class="btn btn-red px-2 py-0.5 text-xs ml-2 flex-shrink-0">ğŸ—‘ï¸ Smazat</button>
                        </div>`;
                    }).join('');
                }

                document.getElementById('admin-logy-box').classList.remove('hidden');
            } catch(e) {
                notify('Chyba: ' + e.message);
            } finally {
                document.getElementById('admin-logy-loading').classList.add('hidden');
            }
        });

        window.adminSmazatZapis = async (logId, pivo, hospoda) => {
            if (!adminVybranyHracUid) return;
            if (!confirm('Smazat zÃ¡znam "' + pivo + '" @ ' + hospoda + '? OdeÄte -100 XP hrÃ¡Äi.')) return;

            try {
                const batch = writeBatch(db);
                const logRef = doc(db, "hraci", adminVybranyHracUid, "log_piv", logId);
                batch.delete(logRef);

                // OdeÄti XP hrÃ¡Äi
                batch.update(doc(db, "hraci", adminVybranyHracUid), { xp: increment(-100) });

                // OdeÄti ze statistik
                const bezTecky = hospoda.replace(/\./g, '_');
                await batch.commit();

                try { await updateDoc(doc(db, "statistiky_piv", pivo), { pocet: increment(-1) }); } catch(e) {}
                try { await updateDoc(doc(db, "statistiky_hospod", bezTecky), { pocet: increment(-1) }); } catch(e) {}

                // OdstraÅˆ Å™Ã¡dek z UI
                const row = document.getElementById('logrow-' + logId);
                if (row) row.remove();

                // Aktualizuj zobrazenÃ© XP
                const hSnap = await getDoc(doc(db, "hraci", adminVybranyHracUid));
                if (hSnap.exists()) {
                    document.getElementById('admin-hrac-xp').textContent = (hSnap.data().xp || 0) + ' XP';
                }

                notify('ZÃ¡znam smazÃ¡n a -100 XP odeÄteno.');
            } catch(e) {
                notify('Chyba pÅ™i mazÃ¡nÃ­: ' + e.message);
            }
        };

        // â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // â”€â”€â”€ MIGRACE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // AktuÃ¡lnÃ­ verze schÃ©matu â€“ zvyÅ¡uj pÅ™i kaÅ¾dÃ© novÃ© funkci co pÅ™idÃ¡ pole
        const SCHEMA_VERZE = 2;

        // Co kaÅ¾dÃ¡ verze pÅ™idÃ¡vÃ¡:
        // v1 â†’ zÃ¡kladnÃ­ pole: email, prezdivka, xp, dungeony, cech_id
        // v2 â†’ cech_zakladatel (bool)
        // v3 â†’ sem pÅ™idej pÅ™Ã­Å¡tÄ›...

        function logLine(boxId, text, color = '#86efac') {
            const box = $(boxId);
            box.classList.remove('hidden');
            const line = document.createElement('div');
            line.style.color = color;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            box.appendChild(line);
            box.scrollTop = box.scrollHeight;
        }

        // â”€â”€ 1. PÅ™epoÄÃ­tat statistiky piv & hospod â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        $('btn-migrace-statistiky').addEventListener('click', async () => {
            if (!confirm('Spustit pÅ™epoÄet statistik? StÃ¡vajÃ­cÃ­ data budou PÅ˜IÄŒTENA (ne smazÃ¡na). Pro ÄistÃ½ pÅ™epoÄet pouÅ¾ij Reset.')) return;
            await spustMigraciStatistik('migrace-statistiky-log', false);
        });

        $('btn-reset-statistiky').addEventListener('click', async () => {
            if (!confirm('VAROVÃNÃ: Toto smaÅ¾e vÅ¡echny statistiky piv a hospod a pÅ™epoÄÃ­tÃ¡ je od nuly. PokraÄovat?')) return;
            await spustMigraciStatistik('reset-statistiky-log', true);
        });

        async function spustMigraciStatistik(logId, resetNejdrive) {
            const box = $(logId);
            box.innerHTML = '';
            box.classList.remove('hidden');
            const btn = resetNejdrive ? $('btn-reset-statistiky') : $('btn-migrace-statistiky');
            btn.disabled = true;

            try {
                // Reset stÃ¡vajÃ­cÃ­ch statistik pokud je poÅ¾adovÃ¡n
                if (resetNejdrive) {
                    logLine(logId, 'MaÅ¾u stÃ¡vajÃ­cÃ­ statistiky piv...');
                    const pivSnap = await getDocs(collection(db, "statistiky_piv"));
                    let delBatch = writeBatch(db);
                    let delCount = 0;
                    for (const d of pivSnap.docs) {
                        delBatch.delete(d.ref);
                        delCount++;
                        if (delCount % 400 === 0) { await delBatch.commit(); delBatch = writeBatch(db); }
                    }
                    await delBatch.commit();
                    logLine(logId, `  â†’ SmazÃ¡no ${delCount} zÃ¡znamÅ¯ piv.`);

                    logLine(logId, 'MaÅ¾u stÃ¡vajÃ­cÃ­ statistiky hospod...');
                    const hospSnap = await getDocs(collection(db, "statistiky_hospod"));
                    let delBatch2 = writeBatch(db);
                    let delCount2 = 0;
                    for (const d of hospSnap.docs) {
                        delBatch2.delete(d.ref);
                        delCount2++;
                        if (delCount2 % 400 === 0) { await delBatch2.commit(); delBatch2 = writeBatch(db); }
                    }
                    await delBatch2.commit();
                    logLine(logId, `  â†’ SmazÃ¡no ${delCount2} zÃ¡znamÅ¯ hospod.`);
                }

                // NaÄti vÅ¡echny hrÃ¡Äe
                logLine(logId, 'NaÄÃ­tÃ¡m seznam hrÃ¡ÄÅ¯...');
                const hraciSnap = await getDocs(collection(db, "hraci"));
                logLine(logId, `  â†’ Nalezeno ${hraciSnap.size} hrÃ¡ÄÅ¯.`);

                const poctyPiv = {};
                const poctyHospod = {};
                let celkemLogu = 0;

                // Projdi logy kaÅ¾dÃ©ho hrÃ¡Äe
                for (const hracDoc of hraciSnap.docs) {
                    logLine(logId, `ÄŒtu logy: ${hracDoc.data().prezdivka ?? hracDoc.id}...`, '#fbbf24');
                    try {
                        const logSnap = await getDocs(
                            collection(db, "hraci", hracDoc.id, "log_piv")
                        );
                        logSnap.forEach(l => {
                            const data = l.data();
                            if (data.pivo)   poctyPiv[data.pivo]     = (poctyPiv[data.pivo]     || 0) + 1;
                            if (data.hospoda) poctyHospod[data.hospoda] = (poctyHospod[data.hospoda] || 0) + 1;
                            celkemLogu++;
                        });
                        logLine(logId, `  â†’ ${logSnap.size} zÃ¡znamÅ¯.`);
                    } catch (e) {
                        logLine(logId, `  âš  Chyba ÄtenÃ­ logÅ¯: ${e.message}`, '#f87171');
                    }
                }

                logLine(logId, `Celkem ${celkemLogu} zÃ¡pisÅ¯, ${Object.keys(poctyPiv).length} unikÃ¡tnÃ­ch piv, ${Object.keys(poctyHospod).length} hospod.`);
                logLine(logId, 'Zapisuji statistiky piv...');

                // ZÃ¡pis statistik piv (po 400 kvÅ¯li batch limitu)
                let pivBatch = writeBatch(db);
                let pivCount = 0;
                for (const [nazev, pocet] of Object.entries(poctyPiv)) {
                    pivBatch.set(doc(db, "statistiky_piv", nazev), { pocet }, { merge: !resetNejdrive });
                    pivCount++;
                    if (pivCount % 400 === 0) { await pivBatch.commit(); pivBatch = writeBatch(db); }
                }
                await pivBatch.commit();
                logLine(logId, `  â†’ ZapsÃ¡no ${pivCount} piv.`);

                logLine(logId, 'Zapisuji statistiky hospod...');
                let hospBatch = writeBatch(db);
                let hospCount = 0;
                for (const [nazev, pocet] of Object.entries(poctyHospod)) {
                    hospBatch.set(doc(db, "statistiky_hospod", nazev), { pocet }, { merge: !resetNejdrive });
                    hospCount++;
                    if (hospCount % 400 === 0) { await hospBatch.commit(); hospBatch = writeBatch(db); }
                }
                await hospBatch.commit();
                logLine(logId, `  â†’ ZapsÃ¡no ${hospCount} hospod.`);

                logLine(logId, 'âœ… Migrace statistik dokonÄena!', '#34d399');

            } catch (e) {
                logLine(logId, `âŒ Chyba: ${e.message}`, '#f87171');
            } finally {
                btn.disabled = false;
            }
        }

        // â”€â”€ 2. Migrace schÃ©matu hrÃ¡ÄÅ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        $('btn-migrace-hraci').addEventListener('click', async () => {
            if (!confirm('Doplnit chybÄ›jÃ­cÃ­ pole vÅ¡em hrÃ¡ÄÅ¯m?')) return;
            const logId = 'migrace-hraci-log';
            const box = $(logId);
            box.innerHTML = '';
            box.classList.remove('hidden');
            $('btn-migrace-hraci').disabled = true;

            try {
                logLine(logId, 'NaÄÃ­tÃ¡m hrÃ¡Äe...');
                const snap = await getDocs(collection(db, "hraci"));
                logLine(logId, `  â†’ ${snap.size} hrÃ¡ÄÅ¯ nalezeno.`);

                let opraveno = 0;
                let vporizadku = 0;

                for (const d of snap.docs) {
                    const h = d.data();
                    const opravy = {};

                    // KaÅ¾dÃ¡ novÃ¡ verze schÃ©matu pÅ™idÃ¡ svou kontrolu sem:

                    // v1 â€“ zÃ¡kladnÃ­ pole
                    if (!h.prezdivka)                   opravy.prezdivka = h.email?.split('@')[0] ?? 'Hrdina';
                    if (h.xp === undefined)              opravy.xp = 0;
                    if (!h.dungeony)                     opravy.dungeony = {};
                    if (h.cech_id === undefined)         opravy.cech_id = null;

                    // v2 â€“ cech_zakladatel
                    if (h.cech_zakladatel === undefined) opravy.cech_zakladatel = false;

                    // Verze schÃ©matu â€“ pro sledovÃ¡nÃ­
                    if ((h.verze_schematu ?? 0) < SCHEMA_VERZE) opravy.verze_schematu = SCHEMA_VERZE;

                    if (Object.keys(opravy).length > 0) {
                        await updateDoc(d.ref, opravy);
                        logLine(logId, `  âœ ${h.prezdivka ?? d.id}: doplnÄ›no ${Object.keys(opravy).join(', ')}`, '#fbbf24');
                        opraveno++;
                    } else {
                        vporizadku++;
                    }
                }

                logLine(logId, `âœ… Hotovo! Opraveno: ${opraveno}, v poÅ™Ã¡dku: ${vporizadku}`, '#34d399');

            } catch (e) {
                logLine(logId, `âŒ Chyba: ${e.message}`, '#f87171');
            } finally {
                $('btn-migrace-hraci').disabled = false;
            }
        });


        // â”€â”€ 4. SpÃ¡rovat zÃ¡znamy spoleÄnÃ©ho pitÃ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        $('btn-migrace-spolecne').addEventListener('click', async () => {
            const logId = 'migrace-spolecne-log';
            const logEl = $(logId);
            logEl.classList.remove('hidden');
            logEl.innerHTML = '';
            $('btn-migrace-spolecne').disabled = true;

            const logLine = (msg, color) => {
                const d = document.createElement('div');
                d.textContent = msg;
                if (color) d.style.color = color;
                logEl.appendChild(d);
                logEl.scrollTop = logEl.scrollHeight;
            };

            try {
                logLine('NaÄÃ­tÃ¡m vÅ¡echny hrÃ¡Äe...');
                const hraciSnap = await getDocs(collection(db, "hraci"));
                logLine(`Nalezeno ${hraciSnap.size} hrÃ¡ÄÅ¯.`);

                // NaÄti vÅ¡echny logy najednou pomocÃ­ collectionGroup
                logLine('NaÄÃ­tÃ¡m vÅ¡echny logy...');
                const vsechnyLogy = await getDocs(query(
                    collectionGroup(db, "log_piv"),
                    orderBy("cas", "asc")
                ));
                logLine(`Nalezeno ${vsechnyLogy.size} zÃ¡znamÅ¯ celkem.`);

                // Seskup zÃ¡znamy podle hospody
                const podleHospody = {};
                vsechnyLogy.docs.forEach(d => {
                    const data = d.data();
                    if (!data.hospoda || !data.cas) return;
                    if (!podleHospody[data.hospoda]) podleHospody[data.hospoda] = [];
                    podleHospody[data.hospoda].push({
                        ref: d.ref,
                        uid: d.ref.parent.parent.id,
                        cas: data.cas.toDate ? data.cas.toDate() : new Date(data.cas),
                        pivo: data.pivo,
                        spolecne_s: data.spolecne_s || null
                    });
                });

                let sparovano = 0;
                const batch = writeBatch(db);
                let batchCount = 0;

                for (const [hospoda, zaznamy] of Object.entries(podleHospody)) {
                    if (zaznamy.length < 2) continue;

                    // Pro kaÅ¾dÃ½ zÃ¡znam najdi ostatnÃ­ do 5 minut
                    for (let i = 0; i < zaznamy.length; i++) {
                        const z = zaznamy[i];
                        const spoluhraciUids = [];
                        const spoluhraciJmena = [];

                        for (let j = 0; j < zaznamy.length; j++) {
                            if (i === j) continue;
                            const z2 = zaznamy[j];
                            if (z2.uid === z.uid) continue;
                            const rozdilMs = Math.abs(z.cas - z2.cas);
                            if (rozdilMs <= 5 * 60 * 1000) {
                                spoluhraciUids.push(z2.uid);
                                // Zjisti pÅ™ezdÃ­vku
                                const hSnap = hraciSnap.docs.find(d => d.id === z2.uid);
                                if (hSnap) spoluhraciJmena.push(hSnap.data().prezdivka);
                            }
                        }

                        if (spoluhraciJmena.length > 0 && !z.spolecne_s) {
                            batch.update(z.ref, {
                                spolecne_s: spoluhraciJmena.join(', '),
                                spolecne_uids: spoluhraciUids
                            });
                            sparovano++;
                            batchCount++;

                            // Firestore batch limit je 500
                            if (batchCount >= 480) {
                                await batch.commit();
                                logLine(`ZapsÃ¡no ${sparovano} pÃ¡rovÃ¡nÃ­...`);
                                batchCount = 0;
                            }
                        }
                    }
                }

                if (batchCount > 0) await batch.commit();

                logLine(`âœ… Hotovo! SpÃ¡rovÃ¡no ${sparovano} zÃ¡znamÅ¯.`, '#34d399');
            } catch(e) {
                logLine('âŒ Chyba: ' + e.message, '#fc8181');
            } finally {
                $('btn-migrace-spolecne').disabled = false;
            }
        });

        // â”€â”€ 5. Reset KrÃ¡lovstvÃ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        $('btn-reset-kralovstvi').addEventListener('click', async () => {
            if (!confirm('Opravdu smazat vÃ½sledky aktuÃ¡lnÃ­ho mÄ›sÃ­ce krajskÃ© vÃ¡lky?')) return;
            const logEl = $('reset-kralovstvi-log');
            logEl.classList.remove('hidden');
            logEl.innerHTML = '';
            $('btn-reset-kralovstvi').disabled = true;

            const log = (msg, color) => {
                const d = document.createElement('div');
                d.textContent = msg; if (color) d.style.color = color;
                logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight;
            };

            try {
                const mesic = new Date().toISOString().slice(0, 7);
                log('MaÅ¾u kraje za ' + mesic + '...');

                const krajSnap = await getDocs(query(collection(db, "kralovstvi"), where("mesic", "==", mesic)));
                const hracSnap = await getDocs(query(collection(db, "kralovstvi_hraci"), where("mesic", "==", mesic)));

                const batch = writeBatch(db);
                krajSnap.forEach(d => batch.delete(d.ref));
                hracSnap.forEach(d => batch.delete(d.ref));
                await batch.commit();

                log('SmazÃ¡no ' + (krajSnap.size + hracSnap.size) + ' zÃ¡znamÅ¯.', '#34d399');
                log('âœ… Reset dokonÄen!', '#34d399');
            } catch(e) {
                log('âŒ Chyba: ' + e.message, '#fc8181');
            } finally {
                $('btn-reset-kralovstvi').disabled = false;
            }
        });


    </script>
</body>
</html>
