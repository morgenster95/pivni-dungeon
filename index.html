<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pivn√≠ Dungeon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Cinzel:wght@400;700&display=swap');

        :root {
            --bg: #0d0a14;
            --card: rgba(22, 14, 32, 0.97);
            --border: #8b4513;
            --accent: #f6e05e;
            --orange: #ed8936;
            --green: #276749;
            --red: #9b2c2c;
        }

        * { box-sizing: border-box; }
        body {
            background: var(--bg);
            background-image:
                radial-gradient(ellipse at 20% 20%, rgba(139,69,19,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(90,20,10,0.1) 0%, transparent 50%);
            color: #eee;
            font-family: 'Cinzel', serif;
            min-height: 100vh;
        }
        .fantasy-font { font-family: 'Bangers', cursive; text-shadow: 2px 2px 6px #000; letter-spacing: 2px; }
        .glass-card {
            background: var(--card);
            border: 1px solid rgba(139,69,19,0.6);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.04);
        }
        .tab-btn {
            background: rgba(15,10,22,0.8);
            color: #6b7280;
            border-radius: 10px 10px 0 0;
            padding: 10px 4px;
            font-weight: bold;
            font-size: 0.78rem;
            text-align: center;
            font-family: 'Cinzel', serif;
            border: 1px solid rgba(139,69,19,0.3);
            border-bottom: none;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--card);
            color: var(--accent);
            border-color: rgba(139,69,19,0.7);
            border-bottom: 1px solid var(--card);
        }
        #map { height: 340px; width: 100%; border-radius: 8px; border: 1px solid #5d2e0a; z-index: 1; }
        .hidden { display: none !important; }
        #modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.88);
            z-index: 999;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .dungeon-icon-wrapper { position: relative; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .dungeon-circle-bg { font-size: 32px; position: absolute; top: 0; left: 0; z-index: 1; filter: drop-shadow(0 0 3px rgba(0,0,0,0.8)); }
        .dungeon-beer-fg { font-size: 18px; position: absolute; z-index: 2; top: 7px; left: 9px; }

        .btn-primary { background: linear-gradient(135deg, #276749, #1a4731); color: #fff; border: 1px solid #2f7a54; border-radius: 10px; font-family: 'Cinzel', serif; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .btn-primary:hover { filter: brightness(1.2); }
        .btn-danger { background: linear-gradient(135deg, #9b2c2c, #6b1f1f); color: #fff; border: 1px solid #c53030; border-radius: 10px; font-family: 'Cinzel', serif; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .btn-danger:hover { filter: brightness(1.2); }
        .btn-gold { background: linear-gradient(135deg, #b7791f, #975a16); color: #fefcbf; border: 1px solid #d69e2e; border-radius: 10px; font-family: 'Cinzel', serif; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .btn-gold:hover { filter: brightness(1.2); }
        .btn-war { background: linear-gradient(135deg, #7b341e, #9c4221); color: #fed7aa; border: 1px solid #c05621; border-radius: 10px; font-family: 'Cinzel', serif; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .btn-war:hover { filter: brightness(1.2); }

        input, select {
            background: rgba(0,0,0,0.7);
            border: 1px solid rgba(139,69,19,0.5);
            border-radius: 8px;
            color: #fff;
            font-family: 'Cinzel', serif;
            outline: none;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: var(--orange); }
        input::placeholder { color: #6b7280; font-size: 0.85rem; }

        .xp-bar-outer { background: rgba(0,0,0,0.5); border: 1px solid #4a3010; border-radius: 4px; height: 6px; overflow: hidden; }
        .xp-bar-inner { background: linear-gradient(90deg, #d69e2e, #f6e05e); height: 100%; border-radius: 4px; transition: width 0.5s ease; }

        .log-item { background: rgba(0,0,0,0.4); border-left: 2px solid var(--border); border-radius: 0 6px 6px 0; padding: 6px 10px; font-size: 0.75rem; }
        .log-akce { display: flex; gap: 4px; margin-top: 4px; }
        .log-btn { font-size: 0.65rem; padding: 2px 7px; border-radius: 5px; border: none; cursor: pointer; font-family: Cinzel,serif; font-weight: 700; transition: filter 0.15s; }
        .log-btn:hover { filter: brightness(1.3); }
        .log-btn-repeat { background: rgba(39,103,73,0.5); color: #68d391; border: 1px solid #276749; }
        .log-btn-delete { background: rgba(155,44,44,0.4); color: #fc8181; border: 1px solid #9b2c2c; }

        .war-card { background: rgba(90,30,10,0.3); border: 1px solid #c05621; border-radius: 8px; padding: 10px; }
        .war-progress-bar { background: rgba(0,0,0,0.5); border-radius: 4px; height: 8px; overflow: hidden; display: flex; }
        .war-bar-left { background: linear-gradient(90deg, #f6e05e, #d69e2e); height: 100%; transition: width 0.5s; }
        .war-bar-right { background: linear-gradient(90deg, #fc8181, #e53e3e); height: 100%; transition: width 0.5s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease forwards; }

        .rank-badge { display: inline-block; font-size: 0.6rem; padding: 1px 5px; border-radius: 4px; font-weight: bold; margin-left: 4px; vertical-align: middle; }
        .rank-zakladatel { background: #b7791f; color: #fefcbf; }
        .rank-clen { background: #2d3748; color: #a0aec0; }

        /* Graf */
        .chart-toggle { background: rgba(0,0,0,0.5); border: 1px solid rgba(139,69,19,0.4); border-radius: 8px; padding: 2px; display: inline-flex; gap: 2px; }
        .chart-toggle button { border-radius: 6px; padding: 4px 12px; font-size: 0.7rem; font-family: 'Cinzel', serif; font-weight: 700; cursor: pointer; transition: all 0.2s; border: none; color: #9ca3af; background: transparent; }
        .chart-toggle button.active { background: rgba(139,69,19,0.6); color: #f6e05e; }

        /* S√≠≈à sl√°vy */
        .sin-card { background: rgba(0,0,0,0.45); border: 1px solid rgba(139,69,19,0.35); border-radius: 8px; padding: 10px 12px; }
        .sin-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 0.78rem; }
        .sin-row:last-child { border-bottom: none; }
        .sin-row.me { color: #f6e05e; font-weight: bold; }
        .sin-section-title { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; color: #6b7280; font-weight: bold; margin-bottom: 6px; margin-top: 14px; }
        .sin-section-title:first-child { margin-top: 0; }

        .profil-link { cursor:pointer; text-decoration:underline; color:#f6e05e; }
        .profil-link:hover { color:#ed8936; }
        .spolecne-badge { display:inline-block; background:rgba(39,103,73,0.5); border:1px solid #276749; border-radius:4px; padding:1px 6px; font-size:0.65rem; color:#68d391; margin-left:4px; }

        .kraj-card { background: rgba(0,0,0,0.45); border: 1px solid rgba(139,69,19,0.35); border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; }
        .kraj-bar-outer { background: rgba(0,0,0,0.5); border-radius: 4px; height: 10px; overflow: hidden; margin-top: 4px; }
        .kraj-bar-inner { background: linear-gradient(90deg, #d69e2e, #f6e05e); height: 100%; border-radius: 4px; transition: width 0.6s ease; }
        .avatar-option { font-size: 1.8rem; cursor: pointer; padding: 6px; border-radius: 8px; border: 2px solid transparent; transition: all 0.15s; }
        .avatar-option:hover { background: rgba(139,69,19,0.3); }
        .avatar-option.selected { border-color: #f6e05e; background: rgba(139,69,19,0.4); }
        .follow-btn { font-size: 0.7rem; padding: 3px 10px; border-radius: 6px; font-family: Cinzel,serif; font-weight: 700; cursor: pointer; border: none; transition: all 0.2s; }
        .follow-btn.sleduju { background: rgba(39,103,73,0.5); color: #68d391; border: 1px solid #276749; }
        .follow-btn.nesleduju { background: rgba(139,69,19,0.4); color: #f6e05e; border: 1px solid #8b4513; }
    </style>
</head>
<body class="p-2 flex flex-col items-center text-center">

    <h1 class="text-5xl my-4 text-yellow-500 fantasy-font tracking-wider">üçª PIVN√ç DUNGEON</h1>

    <!-- MODAL: N√°vrh nov√©ho piva -->
    <div id="modal-overlay" class="hidden">
        <div class="glass-card w-full max-w-sm p-6 border border-orange-600">
            <h3 class="text-2xl text-orange-400 fantasy-font mb-1">Chyb√≠ mok?</h3>
            <p class="text-xs text-gray-400 mb-4">Navrhni nov√© pivo ‚Äì velmistr ho posoud√≠ a ty z√≠sk√°≈° odmƒõnu.</p>
            <input id="navrh-piva-input" type="text" placeholder="N√°zev piva..." class="w-full p-3 mb-4">
            <div class="flex gap-2">
                <button id="btn-odeslat-navrh" class="btn-primary flex-grow py-3 text-xs uppercase">‚öîÔ∏è Navrhnout</button>
                <button onclick="zavritModal()" class="btn-danger px-4 py-3 text-xs">‚úï</button>
            </div>
        </div>
    </div>

    <!-- P≈òIHL√Å≈†EN√ç -->
    <div id="auth-screen" class="glass-card w-full max-w-md p-6 mt-2">
        <h2 class="text-3xl text-orange-400 fantasy-font mb-6">Vstup do Krƒçmy</h2>
        <input id="auth-nickname" type="text" placeholder="P≈ôezd√≠vka hrdiny (jen pro nov√©)" class="w-full p-3 mb-3">
        <input id="auth-email" type="email" placeholder="E-mail" class="w-full p-3 mb-3">
        <input id="auth-password" type="password" placeholder="Heslo" class="w-full p-3 mb-5">
        <button id="btn-login" class="btn-primary w-full mb-3 py-3 uppercase text-sm">P≈ôihl√°sit se</button>
        <button id="btn-register" class="btn-gold w-full py-3 uppercase text-xs">‚öîÔ∏è Zalo≈æit hrdinu</button>
        <div id="auth-error" class="text-red-400 text-xs mt-3 font-bold"></div>
    </div>

    <!-- HLAVN√ç APLIKACE -->
    <div id="app-screen" class="hidden w-full max-w-md flex-col items-center">

        <!-- Header -->
        <div class="glass-card w-full p-4 mb-3 flex justify-between items-center">
            <div class="text-left">
                <div class="flex items-center gap-2">
                    <span id="user-avatar-display" class="text-2xl">‚öîÔ∏è</span>
                    <span id="user-nickname-display" class="text-yellow-400 font-bold text-xl fantasy-font tracking-wide">Hrdina</span>
                </div>
                <div class="text-xs text-gray-400 mt-1"><span id="user-xp-display" class="text-yellow-300 font-bold">0</span> XP</div>
                <div class="xp-bar-outer w-40 mt-1"><div id="xp-bar" class="xp-bar-inner" style="width:0%"></div></div>
            </div>
            <button id="btn-logout" class="text-red-500 text-xs font-bold underline">Odhl√°sit</button>
        </div>

        <!-- Tabs -->
        <div class="flex w-full mb-[-1px] z-10 justify-between">
            <button id="tab-mapa"      onclick="switchTab('mapa')"      class="tab-btn active w-[19%]" style="font-size:0.68rem">üó∫Ô∏è Mapa</button>
            <button id="tab-denik"     onclick="switchTab('denik')"     class="tab-btn w-[19%]" style="font-size:0.68rem">üìú Den√≠k</button>
            <button id="tab-cech"      onclick="switchTab('cech')"      class="tab-btn w-[19%]" style="font-size:0.68rem">üõ°Ô∏è Cech</button>
            <button id="tab-kralovstvi" onclick="switchTab('kralovstvi')" class="tab-btn w-[19%]" style="font-size:0.68rem">üëë Kraj</button>
            <button id="tab-sin"       onclick="switchTab('sin')"       class="tab-btn w-[19%]" style="font-size:0.68rem">üèÜ S√≠≈à</button>
        </div>

        <div class="glass-card w-full p-4 rounded-tl-none">

            <!-- TAB: MAPA -->
            <div id="obsah-mapa">
                <div id="map"></div>
                <button id="btn-hledej" class="btn-primary w-full py-3 uppercase text-sm mt-3 mb-4">üîç Naj√≠t dungeony v okol√≠</button>
                <div class="pt-3 border-t border-orange-900">
                    <input id="pub-name-input" readonly placeholder="Klikni na hospodu na mapƒõ..." class="w-full p-2 mb-2 text-yellow-400 font-bold cursor-default">
                    <div class="flex gap-2 mb-4">
                        <input id="beer-name-input" list="seznam-piv" placeholder="Vyber nebo napi≈° pivo..." class="flex-grow p-2">
                        <datalist id="seznam-piv"></datalist>
                        <button onclick="document.getElementById('modal-overlay').classList.remove('hidden')" title="Navrhnout chybƒõj√≠c√≠ pivo" class="btn-gold px-3 rounded text-lg">‚ùó</button>
                    </div>
                    <button id="btn-claim" class="btn-primary w-full py-4 text-xl font-black uppercase shadow-lg">üç∫ Zapsat pivo (+100 XP)</button>
                </div>
            </div>

            <!-- TAB: DEN√çƒåEK -->
            <div id="obsah-denik" class="hidden">
                <h3 class="text-orange-400 fantasy-font text-xl mb-3">Kronika Hrdiny</h3>

                <!-- Editace profilu -->
                <div class="glass-card p-4 mb-4 border border-orange-900 text-left">
                    <div class="flex items-center justify-between mb-3">
                        <div class="sin-section-title" style="margin:0">‚öôÔ∏è M≈Øj profil</div>
                        <button id="btn-profil-toggle" onclick="toggleEditProfil()" class="text-xs text-orange-400 underline">Upravit</button>
                    </div>
                    <!-- Zobrazen√≠ -->
                    <div id="profil-zobrazeni" class="flex items-center gap-3">
                        <div class="text-3xl" id="muj-avatar-display">‚öîÔ∏è</div>
                        <div>
                            <div class="text-yellow-400 font-bold" id="muj-nick-display">‚Äî</div>
                            <div class="text-xs text-gray-400" id="muj-bio-display"></div>
                            <div class="text-xs text-orange-400" id="muj-kraj-display"></div>
                        </div>
                    </div>
                    <!-- Editace (skryt√°) -->
                    <div id="profil-editace" class="hidden mt-3 space-y-3">
                        <!-- Avatar v√Ωbƒõr -->
                        <div>
                            <div class="text-xs text-gray-400 mb-2">Avatar</div>
                            <div id="avatar-vyber" class="flex flex-wrap gap-1">
                                <span class="avatar-option" data-avatar="‚öîÔ∏è">‚öîÔ∏è</span>
                                <span class="avatar-option" data-avatar="üç∫">üç∫</span>
                                <span class="avatar-option" data-avatar="üõ°Ô∏è">üõ°Ô∏è</span>
                                <span class="avatar-option" data-avatar="üè∞">üè∞</span>
                                <span class="avatar-option" data-avatar="üêâ">üêâ</span>
                                <span class="avatar-option" data-avatar="ü¶Ö">ü¶Ö</span>
                                <span class="avatar-option" data-avatar="üåô">üåô</span>
                                <span class="avatar-option" data-avatar="‚ö°">‚ö°</span>
                                <span class="avatar-option" data-avatar="üî•">üî•</span>
                                <span class="avatar-option" data-avatar="üíÄ">üíÄ</span>
                                <span class="avatar-option" data-avatar="üåü">üåü</span>
                                <span class="avatar-option" data-avatar="üéØ">üéØ</span>
                            </div>
                        </div>
                        <!-- P≈ôezd√≠vka -->
                        <div>
                            <div class="text-xs text-gray-400 mb-1">P≈ôezd√≠vka</div>
                            <input id="edit-prezdivka" type="text" class="w-full p-2 text-sm" placeholder="P≈ôezd√≠vka hrdiny...">
                        </div>
                        <!-- Bio -->
                        <div>
                            <div class="text-xs text-gray-400 mb-1">Bio</div>
                            <input id="edit-bio" type="text" class="w-full p-2 text-sm" placeholder="P√°r slov o tobƒõ..." maxlength="80">
                        </div>
                        <!-- Kraj -->
                        <div>
                            <div class="text-xs text-gray-400 mb-1">Domovsk√Ω kraj <span class="text-red-400">(zmƒõna vyma≈æe body v aktu√°ln√≠ krajsk√© v√°lce!)</span></div>
                            <select id="edit-kraj" class="w-full p-2 text-sm">
                                <option value="">‚Äî Nevybr√°no ‚Äî</option>
                                <option value="Praha">Praha</option>
                                <option value="St≈ôedoƒçesk√Ω">St≈ôedoƒçesk√Ω kraj</option>
                                <option value="Jihoƒçesk√Ω">Jihoƒçesk√Ω kraj</option>
                                <option value="Plze≈àsk√Ω">Plze≈àsk√Ω kraj</option>
                                <option value="Karlovarsk√Ω">Karlovarsk√Ω kraj</option>
                                <option value="√östeck√Ω">√östeck√Ω kraj</option>
                                <option value="Libereck√Ω">Libereck√Ω kraj</option>
                                <option value="Kr√°lov√©hradeck√Ω">Kr√°lov√©hradeck√Ω kraj</option>
                                <option value="Pardubick√Ω">Pardubick√Ω kraj</option>
                                <option value="Olomouck√Ω">Olomouck√Ω kraj</option>
                                <option value="Moravskoslezsk√Ω">Moravskoslezsk√Ω kraj</option>
                                <option value="Jihomoravsk√Ω">Jihomoravsk√Ω kraj</option>
                                <option value="Zl√≠nsk√Ω">Zl√≠nsk√Ω kraj</option>
                                <option value="Vysoƒçina">Kraj Vysoƒçina</option>
                            </select>
                        </div>
                        <!-- Heslo -->
                        <div>
                            <div class="text-xs text-gray-400 mb-1">Zmƒõna hesla (voliteln√©)</div>
                            <input id="edit-heslo-soucasne" type="password" class="w-full p-2 text-sm mb-2" placeholder="Souƒçasn√© heslo...">
                            <input id="edit-heslo-nove" type="password" class="w-full p-2 text-sm" placeholder="Nov√© heslo (min. 6 znak≈Ø)...">
                        </div>
                        <button id="btn-ulozit-profil" class="btn-primary w-full py-2 text-sm uppercase">üíæ Ulo≈æit profil</button>
                    </div>
                </div>

                <!-- Sledovan√≠ hr√°ƒçi -->
                <div class="mb-4">
                    <div class="sin-section-title">üë• Sleduji hr√°ƒçe</div>
                    <div id="seznam-sledovanych" class="bg-black bg-opacity-50 rounded p-3 border border-gray-800 text-xs space-y-1 max-h-36 overflow-y-auto"></div>
                </div>

                <!-- Graf piv -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="sin-section-title" style="margin:0">M√° obl√≠ben√° piva</div>
                        <div class="chart-toggle">
                            <button id="btn-graf-bar" class="active" onclick="prepnoutGraf('bar')">üìä Bar</button>
                            <button id="btn-graf-pie" onclick="prepnoutGraf('pie')">ü•ß Pie</button>
                        </div>
                    </div>
                    <div class="bg-black bg-opacity-50 rounded border border-gray-800 p-3" style="position:relative;height:220px;">
                        <canvas id="graf-piv"></canvas>
                        <div id="graf-prazdny" class="hidden text-gray-600 italic text-xs text-center pt-16">Zat√≠m ≈æ√°dn√° piva nezaps√°na.</div>
                    </div>
                </div>

                <!-- Nav≈°t√≠ven√© dungeony -->
                <div class="text-left mb-4">
                    <div class="sin-section-title">Nav≈°t√≠ven√© dungeony</div>
                    <div id="seznam-dungeonu" class="bg-black bg-opacity-50 rounded p-3 max-h-36 overflow-y-auto border border-gray-800 text-xs space-y-1"></div>
                </div>

                <!-- Log z√°pis≈Ø -->
                <div class="text-left">
                    <div class="sin-section-title">Posledn√≠ch 20 z√°pis≈Ø</div>
                    <div id="seznam-piv-log" class="bg-black bg-opacity-50 rounded p-3 max-h-64 overflow-y-auto border border-gray-800 space-y-2"></div>
                </div>
            </div>

            <!-- TAB: CECH -->
            <div id="obsah-cech" class="hidden">

                <!-- Pozv√°nky -->
                <div id="panel-pozvanek" class="hidden mb-4"></div>

                <!-- Nen√≠ v cechu -->
                <div id="cech-neexistuje">
                    <h3 class="text-orange-400 fantasy-font text-xl mb-3">Bez cechu jsi pouh√Ω tul√°k</h3>
                    <p class="text-xs text-gray-400 mb-4">Zalo≈æ vlastn√≠ cech nebo poƒçkej na pozv√°nku od jin√Ωch hrdin≈Ø.</p>
                    <input id="novy-cech-nazev" type="text" placeholder="N√°zev cechu..." class="w-full p-2 mb-2">
                    <button id="btn-zalozit-cech" class="btn-gold w-full py-2 uppercase text-sm mb-2">‚öîÔ∏è Zalo≈æit Cech</button>
                </div>

                <!-- Je v cechu -->
                <div id="cech-existuje" class="hidden">
                    <div class="flex items-center justify-center gap-2 mb-1">
                        <h2 id="cech-nazev-zobrazeni" class="text-3xl text-yellow-500 fantasy-font">...</h2>
                    </div>
                    <p class="text-orange-400 text-sm mb-1">Sk√≥re cechu: <span id="cech-skore-zobrazeni" class="text-white font-bold">0</span> üç∫</p>
                    <div id="cech-role-display" class="text-xs text-gray-400 mb-4"></div>

                    <!-- ≈Ωeb≈ô√≠ƒçek ƒçlen≈Ø cechu -->
                    <div class="text-left mb-4">
                        <div class="text-xs text-gray-400 uppercase font-bold mb-2">ƒålenov√© cechu</div>
                        <div id="cech-zebricek" class="bg-black bg-opacity-50 rounded p-2 text-xs space-y-1 max-h-36 overflow-y-auto border border-gray-800"></div>
                    </div>

                    <!-- Pozvat hr√°ƒçe (jen zakladatel) -->
                    <div id="panel-pozvat" class="hidden mb-4">
                        <div class="text-xs text-gray-400 uppercase font-bold mb-2">Pozvat hrdinu</div>
                        <div class="flex gap-2">
                            <input id="pozvanky-email-input" type="email" placeholder="E-mail hr√°ƒçe..." class="flex-grow p-2 text-sm">
                            <button id="btn-poslat-pozvanku" class="btn-gold px-3 text-xs uppercase">Pozvat</button>
                        </div>
                    </div>

                    <!-- Cechovn√≠ v√°lky -->
                    <div class="mb-4">
                        <div class="text-xs text-gray-400 uppercase font-bold mb-2">‚öîÔ∏è Cechovn√≠ V√°lky</div>
                        <div id="panel-valky" class="space-y-2 text-xs"></div>
                        <div id="panel-vyhlasit-valku" class="hidden mt-2">
                            <select id="select-rival-cech" class="w-full p-2 text-sm mb-2">
                                <option value="">‚Äî Vyber soupe≈ôe ‚Äî</option>
                            </select>
                            <button id="btn-vyhlasit-valku" class="btn-war w-full py-2 uppercase text-xs">‚öîÔ∏è Vyhl√°sit v√°lku</button>
                        </div>
                    </div>

                    <!-- Akce -->
                    <div class="flex gap-2 text-xs">
                        <button id="btn-opustit-cech" class="btn-danger flex-grow py-2 uppercase">Opustit cech</button>
                        <button id="btn-rozpustit-cech" class="hidden btn-danger flex-grow py-2 uppercase border border-red-400">üíÄ Rozpustit cech</button>
                    </div>
                </div>

                <!-- Glob√°ln√≠ ≈æeb≈ô√≠ƒçek cechovn√≠ p≈ôesunut do S√≠nƒõ sl√°vy -->

            </div>

            <!-- TAB: KR√ÅLOVSTV√ç -->
            <div id="obsah-kralovstvi" class="hidden">
                <h3 class="text-yellow-500 fantasy-font text-2xl mb-1">üëë Kr√°lovstv√≠</h3>
                <p class="text-xs text-gray-500 mb-1">Krajsk√° v√°lka ‚Äî pije≈° za sv≈Øj kraj</p>
                <div id="kral-reset-info" class="text-xs text-orange-400 mb-4 text-center"></div>

                <!-- Nem√° zvolen√Ω kraj -->
                <div id="kral-bez-kraje" class="hidden text-center py-6">
                    <div class="text-4xl mb-3">üè¥</div>
                    <p class="text-gray-400 text-sm mb-2">Nem√°≈° zvolen√Ω domovsk√Ω kraj.</p>
                    <p class="text-xs text-gray-500">Jdi do z√°lo≈æky <strong class="text-orange-400">Den√≠k ‚Üí M≈Øj profil</strong> a zvol sv≈Øj kraj.</p>
                </div>

                <!-- M√° kraj -->
                <div id="kral-obsah" class="hidden">
                    <!-- M≈Øj kraj -->
                    <div class="kraj-card border-yellow-700 mb-4">
                        <div class="flex justify-between items-center">
                            <span class="text-yellow-400 font-bold text-sm" id="kral-muj-kraj">‚Äî</span>
                            <span class="text-yellow-500 font-bold" id="kral-moje-piva">0 üç∫</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">Tv≈Øj p≈ô√≠spƒõvek: <span id="kral-muj-prispevek" class="text-white">0 piv</span></div>
                    </div>

                    <!-- ≈Ωeb≈ô√≠ƒçek kraj≈Ø -->
                    <div class="sin-section-title">‚öîÔ∏è Po≈ôad√≠ kraj≈Ø (aktu√°ln√≠ kolo)</div>
                    <div id="kral-zebricek" class="space-y-2 mb-4"></div>

                    <!-- SVG mapa ƒåR -->
                    <div class="sin-section-title">üó∫Ô∏è Mapa Kr√°lovstv√≠</div>
                    <div class="bg-black bg-opacity-50 rounded border border-gray-800 p-2 mb-4">
                        <svg id="mapa-cr" viewBox="0 0 800 480" style="width:100%;height:auto;">
                            <!-- Zjednodu≈°en√© kraje ƒåR jako obd√©ln√≠ky/mnoho√∫heln√≠ky -->
                            <!-- Karlovarsk√Ω -->
                            <g class="kraj-svg" data-kraj="Karlovarsk√Ω" onclick="kliknoutKraj('Karlovarsk√Ω')">
                                <rect x="30" y="80" width="110" height="80" rx="4" fill="#1a1a2e" stroke="#8b4513" stroke-width="1.5"/>
                                <text x="85" y="115" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Cinzel,serif">Karlovarsk√Ω</text>
                                <text x="85" y="130" text-anchor="middle" fill="#f6e05e" font-size="12" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="Karlovarsk√Ω">0 üç∫</text>
                            </g>
                            <!-- √östeck√Ω -->
                            <g class="kraj-svg" data-kraj="√östeck√Ω" onclick="kliknoutKraj('√östeck√Ω')">
                                <rect x="145" y="40" width="130" height="90" rx="4" fill="#1a1a2e" stroke="#8b4513" stroke-width="1.5"/>
                                <text x="210" y="80" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Cinzel,serif">√östeck√Ω</text>
                                <text x="210" y="95" text-anchor="middle" fill="#f6e05e" font-size="12" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="√östeck√Ω">0 üç∫</text>
                            </g>
                            <!-- Libereck√Ω -->
                            <g class="kraj-svg" data-kraj="Libereck√Ω" onclick="kliknoutKraj('Libereck√Ω')">
                                <rect x="280" y="40" width="110" height="75" rx="4" fill="#1a1a2e" stroke="#8b4513" stroke-width="1.5"/>
                                <text x="335" y="73" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Cinzel,serif">Libereck√Ω</text>
                                <text x="335" y="88" text-anchor="middle" fill="#f6e05e" font-size="12" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="Libereck√Ω">0 üç∫</text>
                            </g>
                            <!-- Kr√°lov√©hradeck√Ω -->
                            <g class="kraj-svg" data-kraj="Kr√°lov√©hradeck√Ω" onclick="kliknoutKraj('Kr√°lov√©hradeck√Ω')">
                                <rect x="395" y="40" width="130" height="90" rx="4" fill="#1a1a2e" stroke="#8b4513" stroke-width="1.5"/>
                                <text x="460" y="76" text-anchor="middle" fill="#9ca3af" font-size="9" font-family="Cinzel,serif">Kr√°lov√©hradeck√Ω</text>
                                <text x="460" y="91" text-anchor="middle" fill="#f6e05e" font-size="12" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="Kr√°lov√©hradeck√Ω">0 üç∫</text>
                            </g>
                            <!-- Pardubick√Ω -->
                            <g class="kraj-svg" data-kraj="Pardubick√Ω" onclick="kliknoutKraj('Pardubick√Ω')">
                                <rect x="395" y="135" width="130" height="80" rx="4" fill="#1a1a2e" stroke="#8b4513" stroke-width="1.5"/>
                                <text x="460" y="170" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Cinzel,serif">Pardubick√Ω</text>
                                <text x="460" y="185" text-anchor="middle" fill="#f6e05e" font-size="12" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="Pardubick√Ω">0 üç∫</text>
                            </g>
                            <!-- Plze≈àsk√Ω -->
                            <g class="kraj-svg" data-kraj="Plze≈àsk√Ω" onclick="kliknoutKraj('Plze≈àsk√Ω')">
                                <rect x="30" y="165" width="120" height="100" rx="4" fill="#1a1a2e" stroke="#8b4513" stroke-width="1.5"/>
                                <text x="90" y="210" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Cinzel,serif">Plze≈àsk√Ω</text>
                                <text x="90" y="225" text-anchor="middle" fill="#f6e05e" font-size="12" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="Plze≈àsk√Ω">0 üç∫</text>
                            </g>
                            <!-- St≈ôedoƒçesk√Ω -->
                            <g class="kraj-svg" data-kraj="St≈ôedoƒçesk√Ω" onclick="kliknoutKraj('St≈ôedoƒçesk√Ω')">
                                <rect x="155" y="130" width="235" height="100" rx="4" fill="#1a1a2e" stroke="#8b4513" stroke-width="1.5"/>
                                <text x="272" y="175" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Cinzel,serif">St≈ôedoƒçesk√Ω</text>
                                <text x="272" y="190" text-anchor="middle" fill="#f6e05e" font-size="12" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="St≈ôedoƒçesk√Ω">0 üç∫</text>
                            </g>
                            <!-- Praha -->
                            <g class="kraj-svg" data-kraj="Praha" onclick="kliknoutKraj('Praha')">
                                <circle cx="247" cy="160" r="22" fill="#2d1a0e" stroke="#d69e2e" stroke-width="2"/>
                                <text x="247" y="156" text-anchor="middle" fill="#f6e05e" font-size="9" font-family="Cinzel,serif">Praha</text>
                                <text x="247" y="169" text-anchor="middle" fill="#f6e05e" font-size="10" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="Praha">0üç∫</text>
                            </g>
                            <!-- Jihoƒçesk√Ω -->
                            <g class="kraj-svg" data-kraj="Jihoƒçesk√Ω" onclick="kliknoutKraj('Jihoƒçesk√Ω')">
                                <rect x="80" y="270" width="200" height="110" rx="4" fill="#1a1a2e" stroke="#8b4513" stroke-width="1.5"/>
                                <text x="180" y="320" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Cinzel,serif">Jihoƒçesk√Ω</text>
                                <text x="180" y="335" text-anchor="middle" fill="#f6e05e" font-size="12" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="Jihoƒçesk√Ω">0 üç∫</text>
                            </g>
                            <!-- Vysoƒçina -->
                            <g class="kraj-svg" data-kraj="Vysoƒçina" onclick="kliknoutKraj('Vysoƒçina')">
                                <rect x="285" y="235" width="145" height="100" rx="4" fill="#1a1a2e" stroke="#8b4513" stroke-width="1.5"/>
                                <text x="357" y="280" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Cinzel,serif">Vysoƒçina</text>
                                <text x="357" y="295" text-anchor="middle" fill="#f6e05e" font-size="12" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="Vysoƒçina">0 üç∫</text>
                            </g>
                            <!-- Jihomoravsk√Ω -->
                            <g class="kraj-svg" data-kraj="Jihomoravsk√Ω" onclick="kliknoutKraj('Jihomoravsk√Ω')">
                                <rect x="435" y="270" width="155" height="110" rx="4" fill="#1a1a2e" stroke="#8b4513" stroke-width="1.5"/>
                                <text x="512" y="320" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Cinzel,serif">Jihomoravsk√Ω</text>
                                <text x="512" y="335" text-anchor="middle" fill="#f6e05e" font-size="12" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="Jihomoravsk√Ω">0 üç∫</text>
                            </g>
                            <!-- Olomouck√Ω -->
                            <g class="kraj-svg" data-kraj="Olomouck√Ω" onclick="kliknoutKraj('Olomouck√Ω')">
                                <rect x="530" y="155" width="130" height="110" rx="4" fill="#1a1a2e" stroke="#8b4513" stroke-width="1.5"/>
                                <text x="595" y="205" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Cinzel,serif">Olomouck√Ω</text>
                                <text x="595" y="220" text-anchor="middle" fill="#f6e05e" font-size="12" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="Olomouck√Ω">0 üç∫</text>
                            </g>
                            <!-- Zl√≠nsk√Ω -->
                            <g class="kraj-svg" data-kraj="Zl√≠nsk√Ω" onclick="kliknoutKraj('Zl√≠nsk√Ω')">
                                <rect x="595" y="270" width="110" height="90" rx="4" fill="#1a1a2e" stroke="#8b4513" stroke-width="1.5"/>
                                <text x="650" y="312" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Cinzel,serif">Zl√≠nsk√Ω</text>
                                <text x="650" y="327" text-anchor="middle" fill="#f6e05e" font-size="12" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="Zl√≠nsk√Ω">0 üç∫</text>
                            </g>
                            <!-- Moravskoslezsk√Ω -->
                            <g class="kraj-svg" data-kraj="Moravskoslezsk√Ω" onclick="kliknoutKraj('Moravskoslezsk√Ω')">
                                <rect x="665" y="100" width="120" height="165" rx="4" fill="#1a1a2e" stroke="#8b4513" stroke-width="1.5"/>
                                <text x="725" y="175" text-anchor="middle" fill="#9ca3af" font-size="9" font-family="Cinzel,serif">Moravsko-</text>
                                <text x="725" y="188" text-anchor="middle" fill="#9ca3af" font-size="9" font-family="Cinzel,serif">slezsk√Ω</text>
                                <text x="725" y="203" text-anchor="middle" fill="#f6e05e" font-size="12" font-family="Cinzel,serif" class="kraj-piva-text" data-kraj="Moravskoslezsk√Ω">0 üç∫</text>
                            </g>
                        </svg>
                    </div>

                    <!-- Info o resetu -->
                    <div class="text-center text-xs text-gray-500 pb-2">
                        V√Ωsledky se resetuj√≠ ka≈æd√Ω mƒõs√≠c. Statistiky hr√°ƒç≈Ø z≈Øst√°vaj√≠.
                    </div>
                </div>
            </div>

            <!-- TAB: S√ç≈á SL√ÅVY -->
            <div id="obsah-sin" class="hidden">
                <h3 class="text-yellow-500 fantasy-font text-2xl mb-1">üèÜ S√≠≈à Sl√°vy</h3>
                <p class="text-xs text-gray-500 mb-4">Nejvƒõt≈°√≠ hrdinov√© Pivn√≠ho Dungeonu</p>

                <div id="sin-loading" class="text-gray-500 italic text-sm text-center py-6">Naƒç√≠t√°m an√°ly...</div>

                <div id="sin-obsah" class="hidden space-y-3">

                    <!-- Top hr√°ƒçi -->
                    <div class="sin-card">
                        <div class="sin-section-title">‚öîÔ∏è Nejvƒõt≈°√≠ pija≈ôi (XP)</div>
                        <div id="sin-hraci"></div>
                    </div>

                    <!-- Top cechy -->
                    <div class="sin-card">
                        <div class="sin-section-title">üõ°Ô∏è Nejmocnƒõj≈°√≠ cechy</div>
                        <div id="sin-cechy"></div>
                    </div>

                    <!-- Top piva -->
                    <div class="sin-card">
                        <div class="sin-section-title">üç∫ Nejpitƒõj≈°√≠ moky (glob√°lnƒõ)</div>
                        <div id="sin-piva"></div>
                    </div>

                    <!-- Top hospody -->
                    <div class="sin-card">
                        <div class="sin-section-title">üè∞ Nejnav≈°tƒõvovanƒõj≈°√≠ dungeony</div>
                        <div id="sin-hospody"></div>
                    </div>

                </div>
            </div>
        </div>
    </div><!-- /app-screen -->


    <!-- MODAL: Hr√°ƒçsk√Ω profil -->
    <div id="profil-modal-overlay" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;">
        <div class="glass-card w-full max-w-sm p-5 border border-orange-700" style="max-height:90vh;overflow-y:auto;">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-2xl text-yellow-400 fantasy-font" id="profil-nazev">‚Äî</h3>
                <button onclick="zavritProfilModal()" class="text-gray-500 hover:text-white text-xl leading-none">‚úï</button>
            </div>
            <div class="text-center mb-4">
                <div class="text-4xl mb-1" id="profil-avatar">‚öîÔ∏è</div>
                <div class="text-xs text-gray-400" id="profil-level">√örove≈à ‚Äî</div>
                <div class="xp-bar-outer w-32 mx-auto mt-2"><div id="profil-xp-bar" class="xp-bar-inner" style="width:0%"></div></div>
                <div class="text-xs text-yellow-300 mt-1" id="profil-xp">0 XP</div>
            </div>
            <div id="profil-cech-badge" class="text-xs text-center text-orange-400 mb-3 hidden"></div>
            <div class="grid grid-cols-3 gap-2 mb-4 text-center">
                <div class="bg-black bg-opacity-50 rounded p-2">
                    <div class="text-yellow-400 font-bold text-lg" id="profil-pocet-piv">‚Äî</div>
                    <div class="text-[10px] text-gray-500">Piv zaps√°no</div>
                </div>
                <div class="bg-black bg-opacity-50 rounded p-2">
                    <div class="text-yellow-400 font-bold text-lg" id="profil-pocet-hospod">‚Äî</div>
                    <div class="text-[10px] text-gray-500">Hospod</div>
                </div>
                <div class="bg-black bg-opacity-50 rounded p-2">
                    <div class="text-yellow-400 font-bold text-lg" id="profil-level-num">‚Äî</div>
                    <div class="text-[10px] text-gray-500">√örove≈à</div>
                </div>
            </div>
            <div class="text-left mb-3">
                <div class="sin-section-title">Obl√≠ben√© pivo</div>
                <div class="text-sm text-yellow-300 font-bold" id="profil-oblibene-pivo">‚Äî</div>
            </div>
            <div class="text-left mb-3">
                <div class="sin-section-title">Obl√≠ben√° hospoda</div>
                <div class="text-sm text-yellow-300 font-bold" id="profil-oblibena-hospoda">‚Äî</div>
            </div>
            <div class="text-left mb-2">
                <div class="sin-section-title">Bio</div>
                <div class="text-xs text-gray-300" id="profil-bio">‚Äî</div>
            </div>
            <div class="text-left mb-3">
                <div class="sin-section-title">Kraj</div>
                <div class="text-xs text-orange-400" id="profil-kraj">‚Äî</div>
            </div>
            <div id="profil-akce" class="mt-4 space-y-2 hidden">
                <button id="profil-btn-follow" class="follow-btn nesleduju w-full py-2 hidden">‚ûï Sledovat</button>
                <button id="profil-btn-pozvat" class="btn-gold w-full py-2 text-xs uppercase hidden">üì¨ Pozvat do cechu</button>
            </div>
            <div id="profil-loading" class="text-gray-500 italic text-sm text-center py-4">Naƒç√≠t√°m...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, reauthenticateWithCredential, updatePassword, EmailAuthProvider }
            from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, collectionGroup,
                 addDoc, query, where, getDocs, orderBy, limit, deleteDoc, writeBatch, serverTimestamp, Timestamp }
            from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ‚îÄ‚îÄ‚îÄ FIREBASE CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const firebaseConfig = {
            apiKey: "AIzaSyCrtK_99uh1SGyj2KhA2ljH3aAhynDnhqI",
            authDomain: "pivnidungeon.firebaseapp.com",
            projectId: "pivnidungeon",
            storageBucket: "pivnidungeon.firebasestorage.app",
            messagingSenderId: "174543526039",
            appId: "1:174543526039:web:be6092c458e376c306b1d2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ‚îÄ‚îÄ‚îÄ KONSTANTY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const ZAKLAD_PIV = [
            "Pilsner Urquell", "Gambrinus 12¬∞", "Kozel 11¬∞", "Radegast 12¬∞",
            "Budvar 12¬∞", "Bernard 11¬∞", "Birell", "Kofola", "Staropramen 12¬∞",
            "Zlatopramen 11¬∞", "Rohozec 11¬∞", "Platan 11¬∞", "Kru≈°ovice 12¬∞"
        ];
        const VALKA_TRVANI_DNI = 7;
        const VALKA_CIL_BODU = 50;

        // Zvy≈°uj p≈ôi ka≈æd√© nov√© funkci kter√° p≈ôid√°v√° pole do hr√°ƒçova dokumentu.
        // Hr√°ƒç s ni≈æ≈°√≠ verzi bude automaticky upgradov√°n p≈ôi p≈ô√≠≈°t√≠m p≈ôihl√°≈°en√≠.
        const SCHEMA_VERZE = 4;

        // Co ka≈æd√° verze p≈ôid√°v√°:
        // v1 ‚Üí email, prezdivka, xp, dungeony, cech_id
        // v2 ‚Üí cech_zakladatel
        // v3 ‚Üí registraci_cas
        // v4 ‚Üí avatar, bio, kraj, sledovani
        // ‚Üê sem p≈ôid√°vej nov√© verze

        // ‚îÄ‚îÄ‚îÄ STAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let map = null, userLatLng = null, currentPubLatLng = null;
        let currentUser = null, userData = {};

        // ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function $(id) { return document.getElementById(id); }
        function show(id) { $(id).classList.remove('hidden'); }
        function hide(id) { $(id).classList.add('hidden'); }
        function setHtml(id, html) { $(id).innerHTML = html; }
        function notify(msg) {
            // Jednoduch√Ω toast m√≠sto alert()
            const t = document.createElement('div');
            t.textContent = msg;
            t.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#2d3748;color:#fff;padding:10px 20px;border-radius:10px;z-index:9999;font-size:0.85rem;border:1px solid #8b4513;font-family:Cinzel,serif;max-width:90%;text-align:center;';
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
        function zavritModal() { $('modal-overlay').classList.add('hidden'); $('navrh-piva-input').value = ''; }
        window.zavritModal = zavritModal;

        // XP level (ka≈æd√Ωch 1000 XP = 1 level)
        function xpLevel(xp) {
            const lvl = Math.floor(xp / 1000) + 1;
            const prog = (xp % 1000) / 1000 * 100;
            return { lvl, prog };
        }

        // ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                hide('auth-screen');
                const el = $('app-screen');
                el.classList.remove('hidden');
                el.style.display = 'flex';
                el.classList.add('flex-col', 'items-center');
                try {
                    await Promise.all([nactiPiva(), loadUserData()]);
                    initMap();
                } catch (e) { console.error("Start error:", e); }
            } else {
                currentUser = null;
                userData = {};
                const el = $('app-screen');
                el.classList.add('hidden');
                el.style.display = '';
                show('auth-screen');
            }
        });

        $('btn-login').addEventListener('click', async () => {
            const email = $('auth-email').value.trim();
            const pass  = $('auth-password').value;
            $('auth-error').textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch(e) { $('auth-error').textContent = 'Chyba: ' + e.message; }
        });

        $('btn-register').addEventListener('click', async () => {
            const nick  = $('auth-nickname').value.trim();
            const email = $('auth-email').value.trim();
            const pass  = $('auth-password').value;
            $('auth-error').textContent = '';
            if (!nick)  { $('auth-error').textContent = 'Zadej p≈ôezd√≠vku!'; return; }
            if (!email) { $('auth-error').textContent = 'Zadej e-mail!'; return; }
            if (pass.length < 6) { $('auth-error').textContent = 'Heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø!'; return; }
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "hraci", cred.user.uid), {
                    email: cred.user.email,
                    prezdivka: nick,
                    xp: 0,
                    dungeony: {},
                    cech_id: null,
                    cech_zakladatel: false,
                    avatar: '‚öîÔ∏è',
                    bio: '',
                    kraj: '',
                    sledovani: [],
                    registraci_cas: serverTimestamp(),
                    verze_schematu: SCHEMA_VERZE
                });
            } catch(e) { $('auth-error').textContent = 'Chyba: ' + e.message; }
        });

        $('btn-logout').addEventListener('click', () => signOut(auth));

        // ‚îÄ‚îÄ‚îÄ DATA U≈ΩIVATELE + AUTO-MIGRACE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadUserData() {
            if (!currentUser) return;
            const ref = doc(db, "hraci", currentUser.uid);
            const snap = await getDoc(ref);

            if (snap.exists()) {
                userData = snap.data();
            } else {
                // Nov√Ω hr√°ƒç ‚Äì vytvo≈ô dokument s aktu√°ln√≠ verz√≠ sch√©matu
                userData = {
                    email: currentUser.email,
                    prezdivka: currentUser.email.split('@')[0],
                    xp: 0,
                    dungeony: {},
                    cech_id: null,
                    cech_zakladatel: false,
                    verze_schematu: SCHEMA_VERZE
                };
                await setDoc(ref, userData);
            }

            // ‚îÄ‚îÄ AUTO-MIGRACE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Spust√≠ se ti≈°e p≈ôi ka≈æd√©m p≈ôihl√°≈°en√≠ pokud je hr√°ƒçova verze zastaral√°.
            // Nikdy nep≈ôepisuje existuj√≠c√≠ data, jen dopl≈àuje chybƒõj√≠c√≠ pole.
            const aktualniVerze = userData.verze_schematu ?? 0;
            if (aktualniVerze < SCHEMA_VERZE) {
                const opravy = {};

                // v1 ‚Üí z√°kladn√≠ pole (pro p≈ô√≠pad velmi star√Ωch √∫ƒçt≈Ø)
                if (!userData.prezdivka)           opravy.prezdivka = currentUser.email.split('@')[0];
                if (userData.xp === undefined)     opravy.xp = 0;
                if (!userData.dungeony)            opravy.dungeony = {};
                if (userData.cech_id === undefined) opravy.cech_id = null;

                // v2 ‚Üí cech_zakladatel
                if (aktualniVerze < 2) {
                    if (userData.cech_zakladatel === undefined) opravy.cech_zakladatel = false;
                }

                // v3 ‚Üí registraci_cas
                if (aktualniVerze < 3) {
                    if (userData.registraci_cas === undefined) opravy.registraci_cas = serverTimestamp();
                }

                // v4 ‚Üí avatar, bio, kraj, sledovani
                if (aktualniVerze < 4) {
                    if (userData.avatar === undefined) opravy.avatar = '‚öîÔ∏è';
                    if (userData.bio === undefined) opravy.bio = '';
                    if (userData.kraj === undefined) opravy.kraj = '';
                    if (userData.sledovani === undefined) opravy.sledovani = [];
                }

                // ‚Üê sem p≈ôid√°vej nov√© verze migrace:
                // if (aktualniVerze < 4) { opravy.nove_pole = defaultniHodnota; }

                opravy.verze_schematu = SCHEMA_VERZE;
                await updateDoc(ref, opravy);
                Object.assign(userData, opravy);
                console.log(`[Migrace] Hr√°ƒç upgradov√°n z v${aktualniVerze} na v${SCHEMA_VERZE}.`);
            }

            vykresliHeader();
            await vykresliDenicek();
        }

        function vykresliHeader() {
            $('user-nickname-display').textContent = userData.prezdivka || 'Hrdina';
            // Avatar v headeru
            const avatarEl = document.getElementById('user-avatar-display');
            if (avatarEl) avatarEl.textContent = userData.avatar || '‚öîÔ∏è';
            const xp = userData.xp || 0;
            $('user-xp-display').textContent = xp;
            const { lvl, prog } = xpLevel(xp);
            $('user-xp-display').textContent = `${xp} XP  |  √örove≈à ${lvl}`;
            $('xp-bar').style.width = prog + '%';
        }

        // ‚îÄ‚îÄ‚îÄ PIVA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let schvalenaPiva = new Set(); // mno≈æina schv√°len√Ωch piv pro validaci p≈ôi z√°pisu

        async function nactiPiva() {
            try {
                const snap = await getDocs(collection(db, "vsechna_piva"));
                let piva = [...ZAKLAD_PIV];
                snap.forEach(d => { if (d.data().nazev) piva.push(d.data().nazev); });
                const unikatni = [...new Set(piva)].sort();
                schvalenaPiva = new Set(unikatni); // ulo≈æ pro validaci
                $('seznam-piv').innerHTML = unikatni
                    .map(p => `<option value="${p.replace(/"/g, '&quot;')}">`).join('');
            } catch (e) { console.error("Chyba naƒç√≠t√°n√≠ piv:", e); }
        }

        // ‚îÄ‚îÄ‚îÄ DEN√çƒåEK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let grafInstance = null;
        let grafData = {};     // { nazevPiva: count }
        let grafTyp = 'bar';

        window.prepnoutGraf = (typ) => {
            grafTyp = typ;
            $('btn-graf-bar').classList.toggle('active', typ === 'bar');
            $('btn-graf-pie').classList.toggle('active', typ === 'pie');
            vykresliGraf(grafData);
        };

        const GRAF_BARVY = [
            '#f6e05e','#ed8936','#fc8181','#68d391','#76e4f7',
            '#b794f4','#fbb6ce','#90cdf4','#faf089','#c6f6d5'
        ];

        function vykresliGraf(pocty) {
            grafData = pocty;
            const canvas = $('graf-piv');
            const prazdny = $('graf-prazdny');

            const entries = Object.entries(pocty).sort((a,b) => b[1]-a[1]).slice(0, 10);

            if (entries.length === 0) {
                canvas.style.display = 'none';
                prazdny.classList.remove('hidden');
                if (grafInstance) { grafInstance.destroy(); grafInstance = null; }
                return;
            }

            canvas.style.display = 'block';
            prazdny.classList.add('hidden');

            const labels = entries.map(([k]) => k);
            const data   = entries.map(([,v]) => v);
            const colors = entries.map((_, i) => GRAF_BARVY[i % GRAF_BARVY.length]);

            if (grafInstance) grafInstance.destroy();

            const ctx = canvas.getContext('2d');
            grafInstance = new Chart(ctx, {
                type: grafTyp === 'pie' ? 'doughnut' : 'bar',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c + 'cc'),
                        borderWidth: 1,
                        borderRadius: grafTyp === 'bar' ? 4 : 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: grafTyp === 'pie',
                            labels: {
                                color: '#d1d5db',
                                font: { family: 'Cinzel', size: 10 },
                                boxWidth: 12,
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => ` ${ctx.parsed}√ó vypito`
                            },
                            bodyFont: { family: 'Cinzel' },
                            titleFont: { family: 'Bangers', size: 14 }
                        }
                    },
                    scales: grafTyp === 'bar' ? {
                        x: {
                            ticks: { color: '#9ca3af', font: { family: 'Cinzel', size: 9 }, maxRotation: 35 },
                            grid: { color: 'rgba(255,255,255,0.04)' }
                        },
                        y: {
                            ticks: { color: '#9ca3af', font: { family: 'Cinzel', size: 9 }, stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.08)' },
                            beginAtZero: true
                        }
                    } : {}
                }
            });
        }
        async function vykresliDenicek() {
            // Dungeony
            const dBox = $('seznam-dungeonu');
            if (userData.dungeony && Object.keys(userData.dungeony).length > 0) {
                const sorted = Object.entries(userData.dungeony).sort((a, b) => b[1] - a[1]);
                dBox.innerHTML = sorted.map(([n, p]) => {
                    const star = p >= 10 ? 'üåü' : p >= 5 ? '‚≠ê' : 'üî∏';
                    const nazev = n.replace(/_/g, '.'); // zpƒõt teƒçky
                    return `<div class="log-item flex justify-between"><span>${star} ${nazev}</span><span class="text-yellow-500">${p}√ó n√°v≈°tƒõv</span></div>`;
                }).join('');
            } else {
                dBox.innerHTML = '<div class="text-gray-600 italic text-center py-2">≈Ω√°dn√© dungeony zat√≠m nenav≈°t√≠veny.</div>';
            }

            // Log piv (subkollekce) + poƒç√≠t√°n√≠ pro graf
            const logBox = $('seznam-piv-log');
            try {
                const q = query(
                    collection(db, "hraci", currentUser.uid, "log_piv"),
                    orderBy("cas", "desc"),
                    limit(200)   // v√≠ce pro p≈ôesn√Ω graf
                );
                const snap = await getDocs(q);

                if (snap.empty) {
                    logBox.innerHTML = '<div class="text-gray-600 italic text-center py-2">Den√≠k je pr√°zdn√Ω.</div>';
                    vykresliGraf({});
                    return;
                }

                // Spoƒç√≠tej piva pro graf
                const pocty = {};
                snap.docs.forEach(d => {
                    const pivo = d.data().pivo;
                    if (pivo) pocty[pivo] = (pocty[pivo] || 0) + 1;
                });
                vykresliGraf(pocty);

                // Zobraz posledn√≠ch 20 s akcemi
                logBox.innerHTML = '';
                snap.docs.slice(0, 20).forEach((d, idx) => {
                    const z = d.data();
                    const casObj = z.cas?.toDate ? z.cas.toDate() : null;
                    const datum = casObj ? casObj.toLocaleDateString('cs-CZ') : '‚Äî';
                    const cas = casObj ? casObj.toLocaleTimeString('cs-CZ', {hour:'2-digit',minute:'2-digit'}) : '';
                    const spolecneHtml = z.spolecne_s
                        ? ' ¬∑ <span class="spolecne-badge">üçª s ' + z.spolecne_s + '</span>'
                        : '';

                    const div = document.createElement('div');
                    div.className = 'log-item fade-in';
                    div.innerHTML =
                        '<div class="flex justify-between items-start">' +
                            '<div>' +
                                '<span class="text-yellow-400 font-bold">üç∫ ' + (z.pivo || '‚Äî') + '</span>' +
                                '<span class="text-gray-400"> @ ' + (z.hospoda || '‚Äî') + '</span>' +
                                '<span class="block text-gray-600 text-[10px]">' + datum + (cas ? ' ¬∑ ' + cas : '') + spolecneHtml + '</span>' +
                            '</div>' +
                            '<div class="log-akce">' +
                                (idx === 0 ? '<button class="log-btn log-btn-repeat" title="Zopakovat z√°pis">üîÅ</button>' : '') +
                                '<button class="log-btn log-btn-delete" title="Smazat z√°znam">üóëÔ∏è</button>' +
                            '</div>' +
                        '</div>';

                    // üîÅ Zopakovat ‚Äî jen u prvn√≠ho z√°znamu
                    if (idx === 0) {
                        div.querySelector('.log-btn-repeat').addEventListener('click', () => {
                            zopakovatzapis(z.pivo, z.hospoda, d.id);
                        });
                    }

                    // üóëÔ∏è Smazat
                    div.querySelector('.log-btn-delete').addEventListener('click', () => {
                        smazatZapis(d.id, d.ref, z);
                    });

                    logBox.appendChild(div);
                });

            } catch (e) {
                logBox.innerHTML = '<div class="text-red-500 text-xs">Chyba naƒç√≠t√°n√≠ den√≠ƒçku.</div>';
            }
        }

        // ‚îÄ‚îÄ‚îÄ MAPA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function initMap() {
            if (map) return;
            map = L.map('map').setView([49.8, 15.5], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OSM'
            }).addTo(map);

            map.on('locationfound', onLocationFound);
            map.on('locationerror', () => notify('Nepoda≈ôilo se zjistit polohu. Povol lokaci v prohl√≠≈æeƒçi.'));
        }

        function onLocationFound(e) {
            userLatLng = e.latlng;
            L.circle(e.latlng, { radius: 30, color: '#f6e05e', fillOpacity: 0.3 }).addTo(map);

            const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];(node["amenity"~"pub|bar|restaurant"](around:1500,${e.latlng.lat},${e.latlng.lng}););out;`;
            fetch(overpassUrl)
                .then(r => r.json())
                .then(data => {
                    data.elements.forEach(h => {
                        const n = h.tags.name || 'Krƒçma';
                        const p = (userData.dungeony && userData.dungeony[n]) || 0;
                        const b = p >= 5 ? 'üü¢' : p > 0 ? 'üü†' : 'üî¥';
                        const icon = L.divIcon({
                            html: `<div class="dungeon-icon-wrapper"><span class="dungeon-circle-bg">${b}</span><span class="dungeon-beer-fg">üç∫</span></div>`,
                            className: '', iconSize: [40, 40]
                        });
                        L.marker([h.lat, h.lon], { icon })
                            .addTo(map)
                            .bindPopup(buildPopup(n, h.lat, h.lon));
                    });
                })
                .catch(() => notify('Nepoda≈ôilo se naƒç√≠st hospody.'));
        }

        function buildPopup(name, lat, lon) {
            const safeName = name.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
            return `<b style="font-family:Cinzel,serif">${name}</b><br>
                <button onclick="window.pickPub('${safeName}',${lat},${lon})"
                    style="background:#c05621;color:#fff;padding:4px 8px;border-radius:6px;margin-top:6px;width:100%;font-size:11px;font-weight:bold;font-family:Cinzel,serif;border:none;cursor:pointer;">
                    üç∫ Tady piju!
                </button>`;
        }

        $('btn-hledej').addEventListener('click', () => {
            if (!map) initMap();
            map.locate({ setView: true, maxZoom: 16 });
        });

        window.pickPub = (n, lat, lng) => {
            $('pub-name-input').value = n;
            currentPubLatLng = L.latLng(lat, lng);
            map.closePopup();
        };

        // ‚îÄ‚îÄ‚îÄ CLAIM XP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        $('btn-claim').addEventListener('click', async () => {
            const pN = $('pub-name-input').value.trim();
            const bN = $('beer-name-input').value.trim();
            if (!pN || !bN) { notify('Vyber hospodu i pivo!'); return; }
            if (!userLatLng)        { notify('Nejprve zjisti svou polohu tlaƒç√≠tkem Naj√≠t dungeony.'); return; }
            if (!currentPubLatLng)  { notify('Klikni na hospodu na mapƒõ!'); return; }

            // Validace ‚Äî pivo mus√≠ b√Ωt v schv√°len√©m seznamu
            if (!schvalenaPiva.has(bN)) {
                notify(`"${bN}" nen√≠ v seznamu schv√°len√Ωch piv. Pou≈æij tlaƒç√≠tko ‚ùó pro n√°vrh nov√©ho piva.`);
                return;
            }

            const dist = map.distance(userLatLng, currentPubLatLng);
            if (dist > 150)         { notify(`Jsi p≈ô√≠li≈° daleko (${Math.round(dist)} m). Mus√≠≈° b√Ωt bl√≠≈æe ne≈æ 150 m!`); return; }

            try {
                $('btn-claim').disabled = true;
                $('btn-claim').textContent = '‚è≥ Zapisuji...';

                const batch = writeBatch(db);

                // Log entry jako subkollekce
                const logRef = doc(collection(db, "hraci", currentUser.uid, "log_piv"));
                batch.set(logRef, {
                    pivo: bN, hospoda: pN, cas: serverTimestamp()
                });

                // Aktualizace hr√°ƒçe ‚Äî dungeony kl√≠ƒç nesm√≠ obsahovat teƒçky (Firestore to bere jako cestu)
                const hracRef = doc(db, "hraci", currentUser.uid);
                const bezTecky = pN.replace(/\./g, '_');
                batch.update(hracRef, {
                    xp: increment(100),
                    [`dungeony.${bezTecky}`]: increment(1)
                });

                await batch.commit();

                // Glob√°ln√≠ statistiky ‚Äî increment() nefunguje v batch.set(), mus√≠me pou≈æ√≠t updateDoc se set+merge zvl√°≈°≈•
                try {
                    await setDoc(doc(db, "statistiky_piv", bN), { pocet: increment(1) }, { merge: true });
                } catch(e) {
                    await setDoc(doc(db, "statistiky_piv", bN), { pocet: 1 });
                }
                try {
                    await setDoc(doc(db, "statistiky_hospod", bezTecky), { pocet: increment(1), nazev: pN }, { merge: true });
                } catch(e) {
                    await setDoc(doc(db, "statistiky_hospod", bezTecky), { pocet: 1, nazev: pN });
                }

                // Krajov√° v√°lka ‚Äî p≈ôiƒçti bod kraji pokud m√° hr√°ƒç zvolen√Ω kraj
                if (userData.kraj) {
                    const mesic = new Date().toISOString().slice(0, 7); // "2025-03"
                    const krajRef = doc(db, "kralovstvi", mesic + '_' + userData.kraj);
                    try {
                        await setDoc(krajRef, {
                            kraj: userData.kraj,
                            mesic: mesic,
                            piv: increment(1)
                        }, { merge: true });
                        // P≈ô√≠spƒõvek hr√°ƒçe
                        const hracKrajRef = doc(db, "kralovstvi_hraci", mesic + '_' + currentUser.uid);
                        await setDoc(hracKrajRef, {
                            uid: currentUser.uid,
                            kraj: userData.kraj,
                            mesic: mesic,
                            piv: increment(1)
                        }, { merge: true });
                    } catch(eKraj) { console.warn('Kraj zapis chyba:', eKraj.message); }
                }

                // Cech sk√≥re + v√°lka body
                if (userData.cech_id) {
                    const cechRef = doc(db, "cechy", userData.cech_id);
                    await updateDoc(cechRef, { skore: increment(1) });
                    await pripoctiValecneBody(pN);
                }

                // Detekce spoluhr√°ƒç≈Ø ‚Äî collection group query p≈ôes log_piv v≈°ech hr√°ƒç≈Ø
                try {
                    const pred5min = new Date(Date.now() - 5 * 60 * 1000);
                    const spoluhraciSnap = await getDocs(query(
                        collectionGroup(db, "log_piv"),
                        where("hospoda", "==", pN),
                        where("cas", ">=", Timestamp.fromDate(pred5min))
                    ));

                    // Filtruj sebe ‚Äî cesta dokumentu: hraci/{uid}/log_piv/{docId}
                    const cizi = spoluhraciSnap.docs.filter(d => d.ref.parent.parent.id !== currentUser.uid);

                    if (cizi.length > 0) {
                        // Unik√°tn√≠ hr√°ƒçi
                        const spoluhraciMap = {};
                        for (const d of cizi) {
                            const uid = d.ref.parent.parent.id;
                            if (!spoluhraciMap[uid]) {
                                const hSnap = await getDoc(doc(db, "hraci", uid));
                                if (hSnap.exists()) {
                                    spoluhraciMap[uid] = { uid, prezdivka: hSnap.data().prezdivka };
                                }
                            }
                        }
                        const spoluhraciList = Object.values(spoluhraciMap);

                        if (spoluhraciList.length > 0) {
                            const jmena = spoluhraciList.map(s => s.prezdivka).join(', ');

                            // Naƒçti pr√°vƒõ zapsan√Ω z√°znam (nejnovƒõj≈°√≠ v m√©m log_piv)
                            const mojLogSnap = await getDocs(query(
                                collection(db, "hraci", currentUser.uid, "log_piv"),
                                orderBy("cas", "desc"), limit(1)
                            ));

                            if (!mojLogSnap.empty) {
                                const batch2 = writeBatch(db);

                                // Dopl≈à spoluhr√°ƒçe do M√âHO z√°znamu
                                batch2.update(mojLogSnap.docs[0].ref, {
                                    spolecne_s: jmena,
                                    spolecne_uids: spoluhraciList.map(s => s.uid)
                                });

                                // Zpƒõtnƒõ dopl≈à Mƒö do JEJICH posledn√≠ho z√°znamu z t√©to hospody
                                for (const sh of spoluhraciList) {
                                    const jejichLog = await getDocs(query(
                                        collection(db, "hraci", sh.uid, "log_piv"),
                                        where("hospoda", "==", pN),
                                        orderBy("cas", "desc"), limit(1)
                                    ));
                                    if (!jejichLog.empty) {
                                        const jd = jejichLog.docs[0].data();
                                        const noveSpolecne = jd.spolecne_s
                                            ? jd.spolecne_s + ', ' + userData.prezdivka
                                            : userData.prezdivka;
                                        const noveUids = [...(jd.spolecne_uids || []), currentUser.uid];
                                        batch2.update(jejichLog.docs[0].ref, {
                                            spolecne_s: noveSpolecne,
                                            spolecne_uids: noveUids
                                        });
                                    }
                                }

                                await batch2.commit();
                                notify('Zaps√°no! +100 XP üç∫  ¬∑  üçª Pije≈° s: ' + jmena);
                            } else {
                                notify('Zaps√°no! +100 XP üç∫');
                            }
                        } else {
                            notify('Zaps√°no! +100 XP üç∫');
                        }
                    } else {
                        notify('Zaps√°no! +100 XP üç∫');
                    }
                } catch(eSpol) {
                    console.warn('Detekce spoluhr√°ƒç≈Ø selhala:', eSpol.message);
                    notify('Zaps√°no! +100 XP üç∫');
                }

                $('beer-name-input').value = '';
                await loadUserData();
            } catch (e) {
                notify('Chyba: ' + e.message);
            } finally {
                $('btn-claim').disabled = false;
                $('btn-claim').textContent = 'üç∫ Zapsat pivo (+100 XP)';
            }
        });

        // ‚îÄ‚îÄ‚îÄ N√ÅVRH PIVA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        $('btn-odeslat-navrh').addEventListener('click', async () => {
            const val = $('navrh-piva-input').value.trim();
            if (!val) { notify('Napi≈° n√°zev piva!'); return; }
            const hospoda = $('pub-name-input').value.trim() || 'Nezad√°no';
            try {
                await addDoc(collection(db, "navrhy_piv"), {
                    nazev_piva: val,
                    hospoda: hospoda,
                    navrhl: userData.prezdivka,
                    navrhl_uid: currentUser.uid,
                    cas: serverTimestamp(),       // ƒças odesl√°n√≠ n√°vrhu = ƒças z√°pisu do den√≠ƒçku po schv√°len√≠
                    stav: 'ceka_na_schvaleni'
                });
                notify('N√°vrh odesl√°n! Velmistr posoud√≠ brzy. Po schv√°len√≠ se pivo zap√≠≈°e do den√≠ƒçku s dne≈°n√≠m datem a touto hospodou.');
                zavritModal();
            } catch (e) { notify('Chyba: ' + e.message); }
        });

        // ‚îÄ‚îÄ‚îÄ TABY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.switchTab = (tabName) => {
            ['mapa', 'denik', 'cech', 'kralovstvi', 'sin'].forEach(t => {
                $(`tab-${t}`).classList.remove('active');
                $(`obsah-${t}`).classList.add('hidden');
            });
            $(`tab-${tabName}`).classList.add('active');
            $(`obsah-${tabName}`).classList.remove('hidden');
            if (tabName === 'mapa' && map) setTimeout(() => map.invalidateSize(), 50);
            if (tabName === 'denik') { vykresliDenicek(); vykresliEditProfil(); nactiSledovane(); }
            if (tabName === 'cech') nactiVseOkoloCechu();
            if (tabName === 'kralovstvi') nactiKralovstvi();
            if (tabName === 'sin') nactiSinSlavy();
        };

        // ‚îÄ‚îÄ‚îÄ CECH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function nactiVseOkoloCechu() {
            await nactiPozvankyCechu();
            if (userData.cech_id) {
                await vykresliCech();
            } else {
                hide('cech-existuje');
                show('cech-neexistuje');
            }
        }

        async function nactiPozvankyCechu() {
            if (!userData.email || userData.cech_id) { hide('panel-pozvanek'); return; }
            const q = query(collection(db, "pozvanky"), where("cilovy_email", "==", userData.email));
            const snap = await getDocs(q);
            const panel = $('panel-pozvanek');
            if (snap.empty) { hide('panel-pozvanek'); return; }

            show('panel-pozvanek');
            panel.innerHTML = '<div class="text-xs text-orange-400 uppercase font-bold mb-2">üì¨ Pozv√°nky do cechu</div>';
            snap.forEach(d => {
                const p = d.data();
                const card = document.createElement('div');
                card.className = 'bg-black bg-opacity-50 border border-yellow-800 rounded p-2 flex justify-between items-center mb-2 text-xs';
                card.innerHTML = `<span class="text-yellow-400 font-bold">${p.cech_nazev}</span>`;
                const btn = document.createElement('button');
                btn.textContent = '‚úì P≈ôijmout';
                btn.className = 'btn-primary px-3 py-1 text-xs';
                btn.dataset.id = d.id;
                btn.dataset.cid = p.cech_id;
                btn.addEventListener('click', () => prijmoutPozvanku(d.id, p.cech_id));
                card.appendChild(btn);
                panel.appendChild(card);
            });
        }

        async function vykresliCech() {
            hide('cech-neexistuje');
            show('cech-existuje');

            const cSnap = await getDoc(doc(db, "cechy", userData.cech_id));
            if (!cSnap.exists()) {
                // Cech byl zru≈°en ‚Äì vyƒçisti hr√°ƒçe
                await updateDoc(doc(db, "hraci", currentUser.uid), { cech_id: null, cech_zakladatel: false });
                userData.cech_id = null; userData.cech_zakladatel = false;
                hide('cech-existuje'); show('cech-neexistuje');
                return;
            }
            const cech = cSnap.data();
            $('cech-nazev-zobrazeni').textContent = cech.nazev;
            $('cech-skore-zobrazeni').textContent = cech.skore ?? 0;

            const jeZakladatel = cech.zakladatel === currentUser.uid;
            $('cech-role-display').textContent = jeZakladatel ? 'üëë Zakladatel cechu' : '‚öîÔ∏è ƒålen cechu';

            // Tlaƒç√≠tko rozpustit jen pro zakladatele
            if (jeZakladatel) { show('btn-rozpustit-cech'); show('panel-pozvat'); }
            else              { hide('btn-rozpustit-cech'); hide('panel-pozvat'); }

            // ≈Ωeb≈ô√≠ƒçek ƒçlen≈Ø
            await nactiClenyCechu();

            // V√°lky
            await nactiValky();
        }

        async function nactiClenyCechu() {
            const q = query(collection(db, "hraci"), where("cech_id", "==", userData.cech_id), orderBy("xp", "desc"));
            const snap = await getDocs(q);
            const cSnap = await getDoc(doc(db, "cechy", userData.cech_id));
            const zakladatelUid = cSnap.data().zakladatel;
            const box = $('cech-zebricek');
            if (snap.empty) { box.innerHTML = '<div class="text-gray-600">≈Ω√°dn√≠ ƒçlenov√©.</div>'; return; }
            box.innerHTML = snap.docs.map((d, i) => {
                const h = d.data(); const isZ = d.id === zakladatelUid;
                const isMe = d.id === currentUser.uid;
                return `<div class="flex justify-between items-center">
                    <span>${i+1}. <span class="${isMe ? '' : 'profil-link'}" ${isMe ? '' : 'onclick="otevritProfil(\'' + d.id + '\')"'}>${h.prezdivka}</span> ${isZ ? '<span class="rank-badge rank-zakladatel">Zakladatel</span>' : ''}</span>
                    <span class="text-yellow-500">${h.xp ?? 0} XP</span>
                </div>`;
            }).join('');
        }

        // ‚îÄ‚îÄ‚îÄ CECH AKCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        $('btn-zalozit-cech').addEventListener('click', async () => {
            const n = $('novy-cech-nazev').value.trim();
            if (!n) { notify('Zadej n√°zev cechu!'); return; }
            if (userData.cech_id) { notify('U≈æ jsi v cechu!'); return; }
            try {
                const ref = await addDoc(collection(db, "cechy"), {
                    nazev: n, zakladatel: currentUser.uid, skore: 0, zalozen: serverTimestamp()
                });
                await updateDoc(doc(db, "hraci", currentUser.uid), {
                    cech_id: ref.id, cech_zakladatel: true
                });
                notify(`Cech "${n}" byl zalo≈æen!`);
                await loadUserData();
                await nactiVseOkoloCechu();
            } catch (e) { notify('Chyba: ' + e.message); }
        });

        $('btn-opustit-cech').addEventListener('click', async () => {
            if (!confirm('Opravdu chce≈° opustit cech?')) return;
            const cechId = userData.cech_id;
            const cSnap = await getDoc(doc(db, "cechy", cechId));
            if (!cSnap.exists()) {
                await updateDoc(doc(db, "hraci", currentUser.uid), { cech_id: null, cech_zakladatel: false });
                userData.cech_id = null;
                await loadUserData(); await nactiVseOkoloCechu(); return;
            }
            const jeZakladatel = cSnap.data().zakladatel === currentUser.uid;

            if (jeZakladatel) {
                // Najdi nejstar≈°√≠ho dal≈°√≠ho ƒçlena podle registraci_cas
                const clenoveSnanp = await getDocs(query(
                    collection(db, "hraci"),
                    where("cech_id", "==", cechId),
                    orderBy("registraci_cas", "asc")
                ));
                const ostatni = clenoveSnanp.docs.filter(d => d.id !== currentUser.uid);
                if (ostatni.length === 0) {
                    // Nikdo jin√Ω v cechu ‚Äî cech se automaticky rozpust√≠
                    if (!confirm('Jsi jedin√Ω ƒçlen cechu. Odchodem cech zanikne. Pokraƒçovat?')) return;
                    const batch2 = writeBatch(db);
                    const valkyS1 = await getDocs(query(collection(db, "valky"), where("utocnik_id","==",cechId)));
                    const valkyS2 = await getDocs(query(collection(db, "valky"), where("obrance_id","==",cechId)));
                    valkyS1.forEach(d => batch2.delete(d.ref));
                    valkyS2.forEach(d => batch2.delete(d.ref));
                    batch2.delete(doc(db, "cechy", cechId));
                    batch2.update(doc(db, "hraci", currentUser.uid), { cech_id: null, cech_zakladatel: false });
                    await batch2.commit();
                    userData.cech_id = null; userData.cech_zakladatel = false;
                    notify('Byl jsi posledn√≠ ƒçlen ‚Äî cech byl rozpu≈°tƒõn.');
                    await loadUserData(); await nactiVseOkoloCechu(); return;
                }
                // P≈ôedej zakladatelstv√≠ nejstar≈°√≠mu ƒçlenovi
                const novyZakladatel = ostatni[0];
                const batch3 = writeBatch(db);
                batch3.update(doc(db, "cechy", cechId), { zakladatel: novyZakladatel.id });
                batch3.update(novyZakladatel.ref, { cech_zakladatel: true });
                batch3.update(doc(db, "hraci", currentUser.uid), { cech_id: null, cech_zakladatel: false });
                await batch3.commit();
                notify('Veden√≠ cechu p≈ôed√°no hr√°ƒçi ' + novyZakladatel.data().prezdivka + '. Opustil jsi cech.');
            } else {
                await updateDoc(doc(db, "hraci", currentUser.uid), { cech_id: null, cech_zakladatel: false });
                notify('Opustil jsi cech.');
            }
            userData.cech_id = null;
            await loadUserData();
            await nactiVseOkoloCechu();
        });

        $('btn-rozpustit-cech').addEventListener('click', async () => {
            if (!confirm('Opravdu rozpustit cel√Ω cech? V≈°ichni ƒçlenov√© budou vyhozeni a ve≈°ker√° data cechu smaz√°na!')) return;
            try {
                const cechId = userData.cech_id;
                // Najdi v≈°echny ƒçleny a odeber jim cech_id
                const clenoveSnanp = await getDocs(query(collection(db, "hraci"), where("cech_id", "==", cechId)));
                const batch = writeBatch(db);
                clenoveSnanp.forEach(d => {
                    batch.update(d.ref, { cech_id: null, cech_zakladatel: false });
                });
                // Sma≈æ aktivn√≠ v√°lky cechu
                const valkySnap = await getDocs(query(collection(db, "valky"),
                    where("utocnik_id", "==", cechId)));
                const valkySnap2 = await getDocs(query(collection(db, "valky"),
                    where("obrance_id", "==", cechId)));
                valkySnap.forEach(d => batch.delete(d.ref));
                valkySnap2.forEach(d => batch.delete(d.ref));
                // Sma≈æ cech
                batch.delete(doc(db, "cechy", cechId));
                await batch.commit();
                userData.cech_id = null; userData.cech_zakladatel = false;
                notify('Cech byl rozpu≈°tƒõn.');
                await loadUserData();
                await nactiVseOkoloCechu();
            } catch (e) { notify('Chyba: ' + e.message); }
        });

        $('btn-poslat-pozvanku').addEventListener('click', async () => {
            const email = $('pozvanky-email-input').value.trim().toLowerCase();
            if (!email) { notify('Zadej e-mail hr√°ƒçe!'); return; }
            if (email === userData.email) { notify('Nem≈Ø≈æe≈° pozvat s√°m sebe!'); return; }

            // Zkontroluj, zda hr√°ƒç existuje
            const q = query(collection(db, "hraci"), where("email", "==", email));
            const snap = await getDocs(q);
            if (snap.empty) { notify('Hr√°ƒç s t√≠mto e-mailem neexistuje.'); return; }

            const hrac = snap.docs[0].data();
            if (hrac.cech_id) { notify('Tento hr√°ƒç je ji≈æ v cechu.'); return; }

            // Zkontroluj duplicitn√≠ pozv√°nku
            const qP = query(collection(db, "pozvanky"), where("cilovy_email", "==", email), where("cech_id", "==", userData.cech_id));
            const snapP = await getDocs(qP);
            if (!snapP.empty) { notify('Tomuto hr√°ƒçi jsi u≈æ poslal pozv√°nku.'); return; }

            const cSnap = await getDoc(doc(db, "cechy", userData.cech_id));
            await addDoc(collection(db, "pozvanky"), {
                cilovy_email: email,
                cech_id: userData.cech_id,
                cech_nazev: cSnap.data().nazev,
                od: userData.prezdivka,
                cas: serverTimestamp()
            });
            $('pozvanky-email-input').value = '';
            notify(`Pozv√°nka odesl√°na na ${email}!`);
        });

        async function prijmoutPozvanku(id, cId) {
            try {
                await updateDoc(doc(db, "hraci", currentUser.uid), { cech_id: cId, cech_zakladatel: false });
                await deleteDoc(doc(db, "pozvanky", id));
                userData.cech_id = cId;
                notify('P≈ôijal jsi pozv√°nku do cechu!');
                await loadUserData();
                await nactiVseOkoloCechu();
            } catch (e) { notify('Chyba: ' + e.message); }
        }

        // ‚îÄ‚îÄ‚îÄ CECHOVN√ç V√ÅLKY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function nactiValky() {
            const cechId = userData.cech_id;
            if (!cechId) return;

            // Naƒçti v√°lky kde jsme √∫toƒçn√≠k nebo br√°nce
            const [qU, qO] = await Promise.all([
                getDocs(query(collection(db, "valky"), where("utocnik_id", "==", cechId))),
                getDocs(query(collection(db, "valky"), where("obrance_id", "==", cechId)))
            ]);

            const valky = [];
            qU.forEach(d => valky.push({ id: d.id, ...d.data(), mujSmer: 'utocnik' }));
            qO.forEach(d => valky.push({ id: d.id, ...d.data(), mujSmer: 'obrance' }));

            const box = $('panel-valky');
            const aktivni = valky.filter(v => v.stav === 'aktivni');
            const cekajici = valky.filter(v => v.stav === 'ceka');

            // Uk√°≈æeme selector pro vyhl√°≈°en√≠ v√°lky, pokud nem√°me aktivn√≠ v√°lku
            const panelVyhlasit = $('panel-vyhlasit-valku');
            if (aktivni.length === 0) {
                show('panel-vyhlasit-valku');
                await nactiCechyProValku(cechId);
            } else {
                hide('panel-vyhlasit-valku');
            }

            if (valky.length === 0) {
                box.innerHTML = '<div class="text-gray-600 italic text-xs text-center py-1">≈Ω√°dn√© aktivn√≠ ani ƒçekaj√≠c√≠ v√°lky.</div>';
                return;
            }

            box.innerHTML = '';
            for (const v of [...aktivni, ...cekajici]) {
                // Zjisti jm√©no soupe≈ôe
                const soupe≈ôId = v.mujSmer === 'utocnik' ? v.obrance_id : v.utocnik_id;
                const soupe≈ôSnap = await getDoc(doc(db, "cechy", soupe≈ôId));
                const soupe≈ôNazev = soupe≈ôSnap.exists() ? soupe≈ôSnap.data().nazev : 'Nezn√°m√Ω cech';

                const nashBodu = v.mujSmer === 'utocnik' ? (v.utocnik_bodu ?? 0) : (v.obrance_bodu ?? 0);
                const jichBodu = v.mujSmer === 'utocnik' ? (v.obrance_bodu ?? 0) : (v.utocnik_bodu ?? 0);
                const totalBodu = nashBodu + jichBodu || 1;
                const nashPct = Math.round(nashBodu / totalBodu * 100);
                const jichPct = 100 - nashPct;

                const konecTs = v.konec?.toDate ? v.konec.toDate() : null;
                const konecStr = konecTs ? konecTs.toLocaleDateString('cs-CZ') : '‚Äî';

                const card = document.createElement('div');
                card.className = 'war-card fade-in';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-orange-400 font-bold">‚öîÔ∏è vs. ${soupe≈ôNazev}</span>
                        <span class="text-[10px] ${v.stav === 'aktivni' ? 'text-green-400' : 'text-yellow-500'}">
                            ${v.stav === 'aktivni' ? 'üî• Aktivn√≠' : '‚è≥ ƒåek√° na p≈ôijet√≠'}
                        </span>
                    </div>
                    ${v.stav === 'aktivni' ? `
                    <div class="war-progress-bar mb-1">
                        <div class="war-bar-left" style="width:${nashPct}%"></div>
                        <div class="war-bar-right" style="width:${jichPct}%"></div>
                    </div>
                    <div class="flex justify-between text-[10px] text-gray-400">
                        <span>My: ${nashBodu} bod≈Ø</span>
                        <span>C√≠l: ${v.cil_bodu ?? VALKA_CIL_BODU}</span>
                        <span>Oni: ${jichBodu} bod≈Ø</span>
                    </div>
                    <div class="text-[10px] text-gray-600 mt-1">Konec: ${konecStr}</div>
                    ` : ''}
                    ${v.stav === 'ceka' && v.mujSmer === 'obrance' ? `
                    <button class="btn-war w-full py-1 mt-2 text-xs" data-vid="${v.id}">‚öîÔ∏è P≈ôijmout v√Ωzvu</button>
                    ` : ''}
                `;

                // P≈ôijmout v√Ωzvu
                const prijmBtn = card.querySelector('[data-vid]');
                if (prijmBtn) {
                    prijmBtn.addEventListener('click', () => prijmoutValku(v.id));
                }

                box.appendChild(card);
            }
        }

        async function nactiCechyProValku(mojeCechId) {
            const q = query(collection(db, "cechy"), orderBy("skore", "desc"), limit(20));
            const snap = await getDocs(q);
            const sel = $('select-rival-cech');
            sel.innerHTML = '<option value="">‚Äî Vyber soupe≈ôsk√Ω cech ‚Äî</option>';
            snap.docs.forEach(d => {
                if (d.id === mojeCechId) return;
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.textContent = `${d.data().nazev} (${d.data().skore ?? 0} üç∫)`;
                sel.appendChild(opt);
            });
        }

        $('btn-vyhlasit-valku').addEventListener('click', async () => {
            const rivalId = $('select-rival-cech').value;
            if (!rivalId) { notify('Vyber soupe≈ôsk√Ω cech!'); return; }
            if (!confirm('Opravdu vyhl√°sit v√°lku? Soupe≈ô ji mus√≠ p≈ôijmout.')) return;

            // Zkontroluj, zda u≈æ v√°lka neexistuje
            const check1 = await getDocs(query(collection(db, "valky"),
                where("utocnik_id", "==", userData.cech_id),
                where("obrance_id", "==", rivalId)));
            if (!check1.empty) { notify('Tomuto cechu jsi ji≈æ vyhl√°sil v√°lku!'); return; }

            try {
                const konec = new Date();
                konec.setDate(konec.getDate() + VALKA_TRVANI_DNI);
                await addDoc(collection(db, "valky"), {
                    utocnik_id: userData.cech_id,
                    obrance_id: rivalId,
                    utocnik_bodu: 0,
                    obrance_bodu: 0,
                    stav: 'ceka', // ƒçek√° na p≈ôijet√≠
                    cil_bodu: VALKA_CIL_BODU,
                    zahajeno: serverTimestamp(),
                    konec: Timestamp.fromDate(konec)
                });
                notify('V√°lka vyhl√°≈°ena! Soupe≈ô ji mus√≠ p≈ôijmout.');
                await nactiValky();
            } catch (e) { notify('Chyba: ' + e.message); }
        });

        async function prijmoutValku(valkaId) {
            if (!confirm('P≈ôijmout v√Ωzvu k v√°lce?')) return;
            await updateDoc(doc(db, "valky", valkaId), { stav: 'aktivni' });
            notify('V√°lka p≈ôijata! A≈• zaƒçne boj! ‚öîÔ∏è');
            await nactiValky();
        }

        async function pripoctiValecneBody(hospoda) {
            if (!userData.cech_id) return;
            // Najdi aktivn√≠ v√°lku
            const [q1, q2] = await Promise.all([
                getDocs(query(collection(db, "valky"),
                    where("utocnik_id", "==", userData.cech_id),
                    where("stav", "==", "aktivni"))),
                getDocs(query(collection(db, "valky"),
                    where("obrance_id", "==", userData.cech_id),
                    where("stav", "==", "aktivni")))
            ]);

            const valky = [];
            q1.forEach(d => valky.push({ id: d.id, smer: 'utocnik' }));
            q2.forEach(d => valky.push({ id: d.id, smer: 'obrance' }));

            for (const v of valky) {
                const pole = v.smer === 'utocnik' ? 'utocnik_bodu' : 'obrance_bodu';
                const vSnap = await getDoc(doc(db, "valky", v.id));
                const vData = vSnap.data();

                // Zkontroluj konec platnosti
                if (vData.konec?.toDate && vData.konec.toDate() < new Date()) {
                    // V√°lka vypr≈°ela ‚Äì vyhodno≈•
                    await vyhodnotValku(v.id, vData);
                    continue;
                }

                const novyBod = (vData[pole] ?? 0) + 1;
                const updateData = { [pole]: novyBod };

                // Kontrola v√≠tƒõze
                if (novyBod >= (vData.cil_bodu ?? VALKA_CIL_BODU)) {
                    updateData.stav = 'skoncila';
                    updateData.vitez = userData.cech_id;
                    await updateDoc(doc(db, "valky", v.id), updateData);
                    // Odmƒõna
                    await updateDoc(doc(db, "cechy", userData.cech_id), { skore: increment(10) });
                    notify('üèÜ V√°≈° cech vyhr√°l v√°lku! +10 bonusov√Ωch bod≈Ø!');
                } else {
                    await updateDoc(doc(db, "valky", v.id), updateData);
                }
            }
        }

        async function vyhodnotValku(valkaId, vData) {
            const vitez = (vData.utocnik_bodu ?? 0) >= (vData.obrance_bodu ?? 0)
                ? vData.utocnik_id : vData.obrance_id;
            await updateDoc(doc(db, "valky", valkaId), { stav: 'skoncila', vitez });
            await updateDoc(doc(db, "cechy", vitez), { skore: increment(5) });
        }

        // ‚îÄ‚îÄ‚îÄ S√ç≈á SL√ÅVY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function nactiSinSlavy() {
            show('sin-loading');
            hide('sin-obsah');

            try {
                // 1. Top hr√°ƒçi podle XP
                const snapHraci = await getDocs(
                    query(collection(db, "hraci"), orderBy("xp", "desc"), limit(10))
                );
                const radkyHraci = snapHraci.docs.map((d, i) => {
                    const h = d.data();
                    const isMe = d.id === currentUser.uid;
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i+1}.`;
                    const jmeno = isMe
                        ? `${h.prezdivka ?? '‚Äî'} üëà`
                        : `<span class="profil-link" onclick="otevritProfil('${d.id}')">${h.prezdivka ?? '‚Äî'}</span>`;
                    return `<div class="sin-row${isMe ? ' me' : ''}">
                        <span>${medal} ${jmeno}</span>
                        <span class="text-yellow-500">${h.xp ?? 0} XP</span>
                    </div>`;
                });
                // Najdi moji pozici pokud nejsem v top 10
                let mojePoziceHrac = '';
                if (!snapHraci.docs.find(d => d.id === currentUser.uid)) {
                    const vsichniSnap = await getDocs(
                        query(collection(db, "hraci"), orderBy("xp", "desc"))
                    );
                    const idx = vsichniSnap.docs.findIndex(d => d.id === currentUser.uid);
                    if (idx >= 0) {
                        mojePoziceHrac = `<div class="sin-row me border-t border-yellow-900 mt-1 pt-1">
                            <span>... ${idx+1}. ${userData.prezdivka} üëà</span>
                            <span class="text-yellow-500">${userData.xp ?? 0} XP</span>
                        </div>`;
                    }
                }
                $('sin-hraci').innerHTML = radkyHraci.join('') + mojePoziceHrac;

                // 2. Top cechy podle sk√≥re
                const snapCechy = await getDocs(
                    query(collection(db, "cechy"), orderBy("skore", "desc"), limit(10))
                );
                const radkyCechy = snapCechy.docs.map((d, i) => {
                    const c = d.data();
                    const isMe = d.id === userData.cech_id;
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i+1}.`;
                    return `<div class="sin-row${isMe ? ' me' : ''}">
                        <span>${medal} ${c.nazev}${isMe ? ' üõ°Ô∏è' : ''}</span>
                        <span class="text-yellow-500">${c.skore ?? 0} üç∫</span>
                    </div>`;
                });
                if (radkyCechy.length === 0) radkyCechy.push('<div class="sin-row"><span class="text-gray-600 italic">≈Ω√°dn√© cechy zat√≠m.</span></div>');
                $('sin-cechy').innerHTML = radkyCechy.join('');

                // 3. Top piva glob√°lnƒõ ‚Äì agregujeme z log_piv v≈°ech hr√°ƒç≈Ø
                // Kv≈Øli Firestore limit≈Øm ƒçteme log ze subcollection group query
                // (vy≈æaduje index "collectionGroup" ‚Äì fallback na vsechna_piva statistiky)
                // M√≠sto toho pou≈æijeme kolekci "statistiky_piv" kterou pln√≠me p≈ôi z√°pisu
                const snapPiva = await getDocs(
                    query(collection(db, "statistiky_piv"), orderBy("pocet", "desc"), limit(10))
                );
                if (snapPiva.empty) {
                    $('sin-piva').innerHTML = '<div class="sin-row"><span class="text-gray-600 italic">Data se shroma≈æƒèuj√≠... zapi≈° prvn√≠ pivo!</span></div>';
                } else {
                    $('sin-piva').innerHTML = snapPiva.docs.map((d, i) => {
                        const p = d.data();
                        const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i+1}.`;
                        return `<div class="sin-row">
                            <span>${medal} ${d.id}</span>
                            <span class="text-yellow-500">${p.pocet}√ó vypito</span>
                        </div>`;
                    }).join('');
                }

                // 4. Top hospody glob√°lnƒõ ‚Äì ze statistiky_hospod
                const snapHospody = await getDocs(
                    query(collection(db, "statistiky_hospod"), orderBy("pocet", "desc"), limit(10))
                );
                if (snapHospody.empty) {
                    $('sin-hospody').innerHTML = '<div class="sin-row"><span class="text-gray-600 italic">Data se shroma≈æƒèuj√≠... zapi≈° prvn√≠ pivo!</span></div>';
                } else {
                    $('sin-hospody').innerHTML = snapHospody.docs.map((d, i) => {
                        const h = d.data();
                        const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i+1}.`;
                        const nazev = h.nazev || d.id.replace(/_/g, '.'); // preferuj ulo≈æen√Ω n√°zev, fallback na ID
                        return `<div class="sin-row">
                            <span>${medal} ${nazev}</span>
                            <span class="text-yellow-500">${h.pocet}√ó nav≈°t√≠veno</span>
                        </div>`;
                    }).join('');
                }

                hide('sin-loading');
                show('sin-obsah');
            } catch (e) {
                $('sin-loading').textContent = 'Chyba naƒç√≠t√°n√≠: ' + e.message;
            }
        }




        // ‚îÄ‚îÄ‚îÄ ZOPAKOVAT Z√ÅPIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.zopakovatzapis = async (pivo, hospoda, posledniId) => {
            if (!pivo || !hospoda) { notify('Chyb√≠ data z√°znamu!'); return; }
            if (!userLatLng) { notify('Nejprve zjisti polohu na z√°lo≈æce Mapa.'); return; }
            if (!currentPubLatLng) {
                // Pokus se naj√≠t hospodu podle jm√©na ‚Äî u≈æivatel mus√≠ b√Ωt na mapƒõ
                notify('P≈ôejdi na Mapu, klikni na hospodu "' + hospoda + '" a pak zkus znovu.');
                return;
            }

            const dist = map.distance(userLatLng, currentPubLatLng);
            if (dist > 150) {
                notify('Jsi p≈ô√≠li≈° daleko (' + Math.round(dist) + ' m). Mus√≠≈° b√Ωt v hospodƒõ!');
                return;
            }

            const pubNazev = $('pub-name-input').value.trim();
            if (pubNazev && pubNazev !== hospoda) {
                notify('Vybran√° hospoda (' + pubNazev + ') se neshoduje s p≈Øvodn√≠ (' + hospoda + ').');
                return;
            }

            if (!confirm('Zopakovat z√°pis: ' + pivo + ' @ ' + hospoda + '?')) return;

            try {
                const batch = writeBatch(db);
                const logRef = doc(collection(db, "hraci", currentUser.uid, "log_piv"));
                batch.set(logRef, { pivo, hospoda, cas: serverTimestamp() });
                const bezTecky = hospoda.replace(/\./g, '_');
                batch.update(doc(db, "hraci", currentUser.uid), {
                    xp: increment(100),
                    ['dungeony.' + bezTecky]: increment(1)
                });
                await batch.commit();

                // Statistiky
                try { await setDoc(doc(db, "statistiky_piv", pivo), { pocet: increment(1) }, { merge: true }); } catch(e) {}
                try { await setDoc(doc(db, "statistiky_hospod", bezTecky), { pocet: increment(1), nazev: hospoda }, { merge: true }); } catch(e) {}
                if (userData.cech_id) {
                    await updateDoc(doc(db, "cechy", userData.cech_id), { skore: increment(1) });
                    await pripoctiValecneBody(hospoda);
                }
                if (userData.kraj) {
                    const mesic = new Date().toISOString().slice(0, 7);
                    try { await setDoc(doc(db, "kralovstvi", mesic + '_' + userData.kraj), { kraj: userData.kraj, mesic, piv: increment(1) }, { merge: true }); } catch(e) {}
                    try { await setDoc(doc(db, "kralovstvi_hraci", mesic + '_' + currentUser.uid), { uid: currentUser.uid, kraj: userData.kraj, mesic, piv: increment(1) }, { merge: true }); } catch(e) {}
                }

                notify('Zopakov√°no! +100 XP üç∫');
                await loadUserData();
            } catch(e) { notify('Chyba: ' + e.message); }
        };

        // ‚îÄ‚îÄ‚îÄ SMAZAT Z√ÅPIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.smazatZapis = async (docId, docRef, z) => {
            if (!confirm('Smazat z√°znam: ' + (z.pivo || '‚Äî') + ' @ ' + (z.hospoda || '‚Äî') + '? Odeƒçte -100 XP a odstran√≠ z√°znam ze statistik.')) return;

            try {
                const batch = writeBatch(db);

                // 1. Sma≈æ log z√°znam
                batch.delete(docRef);

                // 2. Odeƒçti XP a dungeon n√°v≈°tƒõvu
                const bezTecky = (z.hospoda || '').replace(/\./g, '_');
                const hracRef = doc(db, "hraci", currentUser.uid);
                const hracOpravy = { xp: increment(-100) };
                if (z.hospoda) {
                    // Zjisti aktu√°ln√≠ poƒçet n√°v≈°tƒõv ‚Äî nesm√≠ klesnout pod 0
                    const aktualni = (userData.dungeony && userData.dungeony[bezTecky]) || 0;
                    if (aktualni > 0) hracOpravy['dungeony.' + bezTecky] = increment(-1);
                }
                batch.update(hracRef, hracOpravy);

                await batch.commit();

                // 3. Glob√°ln√≠ statistiky (mimo batch)
                if (z.pivo) {
                    try {
                        const pivSnap = await getDoc(doc(db, "statistiky_piv", z.pivo));
                        if (pivSnap.exists() && (pivSnap.data().pocet || 0) > 1) {
                            await updateDoc(doc(db, "statistiky_piv", z.pivo), { pocet: increment(-1) });
                        } else if (pivSnap.exists()) {
                            await deleteDoc(doc(db, "statistiky_piv", z.pivo));
                        }
                    } catch(e) {}
                }
                if (z.hospoda) {
                    try {
                        const hospSnap = await getDoc(doc(db, "statistiky_hospod", bezTecky));
                        if (hospSnap.exists() && (hospSnap.data().pocet || 0) > 1) {
                            await updateDoc(doc(db, "statistiky_hospod", bezTecky), { pocet: increment(-1) });
                        } else if (hospSnap.exists()) {
                            await deleteDoc(doc(db, "statistiky_hospod", bezTecky));
                        }
                    } catch(e) {}
                }

                // 4. Cech sk√≥re
                if (userData.cech_id) {
                    try {
                        const cechSnap = await getDoc(doc(db, "cechy", userData.cech_id));
                        if (cechSnap.exists() && (cechSnap.data().skore || 0) > 0) {
                            await updateDoc(doc(db, "cechy", userData.cech_id), { skore: increment(-1) });
                        }
                    } catch(e) {}
                }

                // 5. Krajov√° v√°lka
                if (userData.kraj) {
                    const mesic = new Date().toISOString().slice(0, 7);
                    try {
                        const hkRef = doc(db, "kralovstvi_hraci", mesic + '_' + currentUser.uid);
                        const hkSnap = await getDoc(hkRef);
                        if (hkSnap.exists() && (hkSnap.data().piv || 0) > 0) {
                            await updateDoc(hkRef, { piv: increment(-1) });
                            const kRef = doc(db, "kralovstvi", mesic + '_' + userData.kraj);
                            const kSnap = await getDoc(kRef);
                            if (kSnap.exists() && (kSnap.data().piv || 0) > 0) {
                                await updateDoc(kRef, { piv: increment(-1) });
                            }
                        }
                    } catch(e) {}
                }

                notify('Z√°znam smaz√°n. -100 XP.');
                await loadUserData();

            } catch(e) { notify('Chyba: ' + e.message); }
        };

        // ‚îÄ‚îÄ‚îÄ EDITACE PROFILU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.toggleEditProfil = () => {
            const ed = $('profil-editace');
            const isHidden = ed.classList.contains('hidden');
            ed.classList.toggle('hidden', !isHidden);
            $('btn-profil-toggle').textContent = isHidden ? 'Zav≈ô√≠t' : 'Upravit';
        };

        function vykresliEditProfil() {
            $('muj-avatar-display').textContent = userData.avatar || '‚öîÔ∏è';
            $('muj-nick-display').textContent = userData.prezdivka || '‚Äî';
            $('muj-bio-display').textContent = userData.bio || '';
            $('muj-kraj-display').textContent = userData.kraj ? 'üìç ' + userData.kraj : 'Kraj nezvol√©n';

            // Nastav hodnoty formul√°≈ôe
            $('edit-prezdivka').value = userData.prezdivka || '';
            $('edit-bio').value = userData.bio || '';
            $('edit-kraj').value = userData.kraj || '';

            // Avatar v√Ωbƒõr
            document.querySelectorAll('.avatar-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.avatar === (userData.avatar || '‚öîÔ∏è'));
                el.onclick = () => {
                    document.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
                    el.classList.add('selected');
                };
            });
        }

        $('btn-ulozit-profil').addEventListener('click', async () => {
            const novyNick = $('edit-prezdivka').value.trim();
            const noveBio = $('edit-bio').value.trim();
            const novyKraj = $('edit-kraj').value;
            const novyAvatar = document.querySelector('.avatar-option.selected')?.dataset.avatar || userData.avatar || '‚öîÔ∏è';
            const soucasneHeslo = $('edit-heslo-soucasne').value;
            const noveHeslo = $('edit-heslo-nove').value;

            if (!novyNick) { notify('P≈ôezd√≠vka nesm√≠ b√Ωt pr√°zdn√°!'); return; }

            try {
                $('btn-ulozit-profil').disabled = true;
                $('btn-ulozit-profil').textContent = '‚è≥ Ukl√°d√°m...';

                const opravy = {
                    prezdivka: novyNick,
                    bio: noveBio,
                    avatar: novyAvatar
                };

                // Zmƒõna kraje ‚Äî vyma≈æe body v aktu√°ln√≠ krajsk√© v√°lce
                if (novyKraj !== (userData.kraj || '')) {
                    if (userData.kraj && novyKraj) {
                        if (!confirm('Zmƒõna kraje vyma≈æe tv≈Øj p≈ô√≠spƒõvek v aktu√°ln√≠ krajsk√© v√°lce. Pokraƒçovat?')) {
                            $('btn-ulozit-profil').disabled = false;
                            $('btn-ulozit-profil').textContent = 'üíæ Ulo≈æit profil';
                            return;
                        }
                    }
                    // Vymaz p≈ô√≠spƒõvek v aktu√°ln√≠m mƒõs√≠ci
                    if (userData.kraj) {
                        const mesic = new Date().toISOString().slice(0, 7);
                        try {
                            await deleteDoc(doc(db, "kralovstvi_hraci", mesic + '_' + currentUser.uid));
                            // Odeƒçti od krajsk√©ho souƒçtu
                            const krajRef = doc(db, "kralovstvi", mesic + '_' + userData.kraj);
                            const krajSnap = await getDoc(krajRef);
                            if (krajSnap.exists()) {
                                const staryPrispevek = (await getDoc(doc(db, "kralovstvi_hraci", mesic + '_' + currentUser.uid)))?.data()?.piv || 0;
                                if (staryPrispevek > 0) {
                                    await updateDoc(krajRef, { piv: increment(-staryPrispevek) });
                                }
                            }
                        } catch(e) { console.warn('Maz√°n√≠ kraj p≈ô√≠spƒõvku:', e); }
                    }
                    opravy.kraj = novyKraj;
                }

                await updateDoc(doc(db, "hraci", currentUser.uid), opravy);
                Object.assign(userData, opravy);

                // Zmƒõna hesla
                if (soucasneHeslo && noveHeslo) {
                    if (noveHeslo.length < 6) { notify('Nov√© heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø!'); return; }
                    try {
                        const credential = EmailAuthProvider.credential(currentUser.email, soucasneHeslo);
                        await reauthenticateWithCredential(currentUser, credential);
                        await updatePassword(currentUser, noveHeslo);
                        $('edit-heslo-soucasne').value = '';
                        $('edit-heslo-nove').value = '';
                        notify('Profil i heslo ulo≈æeny! ‚úì');
                    } catch(eHeslo) {
                        if (eHeslo.code === 'auth/wrong-password') {
                            notify('Souƒçasn√© heslo je ≈°patnƒõ!');
                        } else {
                            notify('Chyba zmƒõny hesla: ' + eHeslo.message);
                        }
                        return;
                    }
                } else {
                    notify('Profil ulo≈æen! ‚úì');
                }

                vykresliHeader();
                vykresliEditProfil();
                toggleEditProfil();

            } catch(e) {
                notify('Chyba: ' + e.message);
            } finally {
                $('btn-ulozit-profil').disabled = false;
                $('btn-ulozit-profil').textContent = 'üíæ Ulo≈æit profil';
            }
        });

        // ‚îÄ‚îÄ‚îÄ SLEDOV√ÅN√ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function nactiSledovane() {
            const box = $('seznam-sledovanych');
            const sledovani = userData.sledovani || [];
            if (sledovani.length === 0) {
                box.innerHTML = '<div class="text-gray-600 italic text-center py-2">Zat√≠m nikoho nesleduje≈°.</div>';
                return;
            }
            box.innerHTML = '<div class="text-gray-500 italic text-center py-1">Naƒç√≠t√°m...</div>';
            const rows = [];
            for (const uid of sledovani) {
                try {
                    const snap = await getDoc(doc(db, "hraci", uid));
                    if (!snap.exists()) continue;
                    const h = snap.data();
                    const { lvl } = xpLevel(h.xp || 0);
                    rows.push('<div class="flex justify-between items-center py-1">' +
                        '<span class="profil-link" onclick="otevritProfil(\'' + uid + '\')">' +
                        (h.avatar || '‚öîÔ∏è') + ' ' + (h.prezdivka || '‚Äî') +
                        '</span>' +
                        '<span class="text-gray-500">√ör. ' + lvl + '</span>' +
                        '</div>');
                } catch(e) {}
            }
            box.innerHTML = rows.length ? rows.join('') : '<div class="text-gray-600 italic text-center py-2">≈Ω√°dn√≠ sledovan√≠.</div>';
        }

        // ‚îÄ‚îÄ‚îÄ KR√ÅLOVSTV√ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.kliknoutKraj = (kraj) => {
            notify('Kraj: ' + kraj + ' ‚Äî statistiky naƒçteny v ≈æeb≈ô√≠ƒçku.');
        };

        async function nactiKralovstvi() {
            const mesic = new Date().toISOString().slice(0, 7);

            // Nastav info o resetu
            const pristiMesic = new Date();
            pristiMesic.setMonth(pristiMesic.getMonth() + 1);
            pristiMesic.setDate(1);
            $('kral-reset-info').textContent = 'Aktu√°ln√≠ kolo: ' + mesic + '  ¬∑  Reset: 1. ' +
                pristiMesic.toLocaleDateString('cs-CZ', {month:'long', year:'numeric'});

            if (!userData.kraj) {
                show('kral-bez-kraje');
                hide('kral-obsah');
                return;
            }
            hide('kral-bez-kraje');
            show('kral-obsah');

            $('kral-muj-kraj').textContent = 'üìç ' + userData.kraj;

            // Naƒçti p≈ô√≠spƒõvek hr√°ƒçe
            try {
                const hracKrajSnap = await getDoc(doc(db, "kralovstvi_hraci", mesic + '_' + currentUser.uid));
                const mojePiv = hracKrajSnap.exists() ? (hracKrajSnap.data().piv || 0) : 0;
                $('kral-muj-prispevek').textContent = mojePiv + ' piv';
            } catch(e) {}

            // Naƒçti v≈°echny kraje v aktu√°ln√≠m mƒõs√≠ci
            try {
                const snap = await getDocs(query(
                    collection(db, "kralovstvi"),
                    where("mesic", "==", mesic),
                    orderBy("piv", "desc")
                ));

                // Naƒçti celkov√Ω poƒçet piv pro kraj p≈ôihl√°≈°en√©ho hr√°ƒçe
                const mojKrajDoc = snap.docs.find(d => d.data().kraj === userData.kraj);
                $('kral-moje-piva').textContent = (mojKrajDoc ? mojKrajDoc.data().piv : 0) + ' üç∫';

                // ≈Ωeb≈ô√≠ƒçek
                const box = $('kral-zebricek');
                if (snap.empty) {
                    box.innerHTML = '<div class="text-gray-600 italic text-center text-xs py-2">Zat√≠m ≈æ√°dn√° piva. Zaƒçni ps√°t za sv≈Øj kraj!</div>';
                } else {
                    const max = snap.docs[0].data().piv || 1;
                    box.innerHTML = snap.docs.map((d, i) => {
                        const k = d.data();
                        const isMe = k.kraj === userData.kraj;
                        const pct = Math.round((k.piv / max) * 100);
                        const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i+1) + '.';
                        return '<div class="kraj-card' + (isMe ? ' border-yellow-600' : '') + '">' +
                            '<div class="flex justify-between items-center">' +
                            '<span class="text-sm ' + (isMe ? 'text-yellow-400 font-bold' : 'text-gray-300') + '">' + medal + ' ' + k.kraj + (isMe ? ' üëà' : '') + '</span>' +
                            '<span class="text-yellow-500 font-bold">' + k.piv + ' üç∫</span>' +
                            '</div>' +
                            '<div class="kraj-bar-outer"><div class="kraj-bar-inner" style="width:' + pct + '%"></div></div>' +
                            '</div>';
                    }).join('');
                }

                // Aktualizuj SVG mapu
                snap.docs.forEach(d => {
                    const k = d.data();
                    const maxPiv = snap.docs[0].data().piv || 1;
                    const intenzita = Math.min(k.piv / maxPiv, 1);
                    // Obarvi kraj na mapƒõ
                    const g = document.querySelector('[data-kraj="' + k.kraj + '"]');
                    if (g) {
                        const rect = g.querySelector('rect, circle');
                        if (rect) {
                            const r = Math.round(26 + intenzita * 100);
                            const g2 = Math.round(26 + intenzita * 60);
                            rect.setAttribute('fill', 'rgb(' + r + ',' + g2 + ',14)');
                        }
                        const txt = g.querySelector('.kraj-piva-text');
                        if (txt) txt.textContent = k.piv + ' üç∫';
                    }
                });

            } catch(e) {
                $('kral-zebricek').innerHTML = '<div class="text-red-400 text-xs">Chyba naƒç√≠t√°n√≠: ' + e.message + '</div>';
            }
        }

        // ‚îÄ‚îÄ‚îÄ HR√ÅƒåSK√ù PROFIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.zavritProfilModal = () => {
            $('profil-modal-overlay').classList.add('hidden');
        };

        window.otevritProfil = async (uid) => {
            $('profil-modal-overlay').classList.remove('hidden');
            $('profil-loading').classList.remove('hidden');
            $('profil-nazev').textContent = '‚Äî';
            $('profil-akce').classList.add('hidden');

            try {
                const snap = await getDoc(doc(db, "hraci", uid));
                if (!snap.exists()) { $('profil-loading').textContent = 'Hr√°ƒç nenalezen.'; return; }
                const h = snap.data();
                const { lvl, prog } = xpLevel(h.xp || 0);

                $('profil-nazev').textContent = h.prezdivka || '‚Äî';
                $('profil-level').textContent = `√örove≈à ${lvl}`;
                $('profil-level-num').textContent = lvl;
                $('profil-xp').textContent = `${h.xp || 0} XP`;
                $('profil-xp-bar').style.width = prog + '%';

                // Avatar podle levelu
                const avatary = ['üç∫','‚öîÔ∏è','üõ°Ô∏è','üèÜ','üëë','üêâ','üåü','üíÄ','üî•','‚ö°'];
                $('profil-avatar').textContent = avatary[Math.min(lvl - 1, avatary.length - 1)];

                // Cech badge
                if (h.cech_id) {
                    const cSnap = await getDoc(doc(db, "cechy", h.cech_id));
                    if (cSnap.exists()) {
                        $('profil-cech-badge').textContent = `üõ°Ô∏è ${cSnap.data().nazev}`;
                        $('profil-cech-badge').classList.remove('hidden');
                    }
                } else {
                    $('profil-cech-badge').classList.add('hidden');
                }

                // Statistiky z log_piv
                const logSnap = await getDocs(query(
                    collection(db, "hraci", uid, "log_piv"),
                    orderBy("cas", "desc"), limit(500)
                ));
                const pocetPiv = logSnap.size;
                const pocetHospod = Object.keys(h.dungeony || {}).length;
                $('profil-pocet-piv').textContent = pocetPiv;
                $('profil-pocet-hospod').textContent = pocetHospod;

                // Obl√≠ben√© pivo
                const poctyPiv = {};
                logSnap.docs.forEach(d => {
                    const p = d.data().pivo;
                    if (p) poctyPiv[p] = (poctyPiv[p] || 0) + 1;
                });
                const oblPivo = Object.entries(poctyPiv).sort((a,b) => b[1]-a[1])[0];
                $('profil-oblibene-pivo').textContent = oblPivo ? `${oblPivo[0]} (${oblPivo[1]}√ó)` : '‚Äî';

                // Obl√≠ben√° hospoda
                const dungeony = h.dungeony || {};
                const oblHosp = Object.entries(dungeony).sort((a,b) => b[1]-a[1])[0];
                $('profil-oblibena-hospoda').textContent = oblHosp
                    ? `${oblHosp[0].replace(/_/g, '.')} (${oblHosp[1]}√ó)` : '‚Äî';

                // Akce ‚Äî pozvat do cechu (jen zakladatel, hr√°ƒç nen√≠ v cechu)
                $('profil-akce').classList.remove('hidden');
                const btnPozvat = $('profil-btn-pozvat');
                if (userData.cech_zakladatel && !h.cech_id && uid !== currentUser.uid) {
                    btnPozvat.classList.remove('hidden');
                    btnPozvat.onclick = async () => {
                        const cSnap = await getDoc(doc(db, "cechy", userData.cech_id));
                        await addDoc(collection(db, "pozvanky"), {
                            cilovy_email: h.email,
                            cech_id: userData.cech_id,
                            cech_nazev: cSnap.data().nazev,
                            od: userData.prezdivka,
                            cas: serverTimestamp()
                        });
                        notify(`Pozv√°nka odesl√°na hr√°ƒçi ${h.prezdivka}!`);
                        btnPozvat.disabled = true;
                        btnPozvat.textContent = '‚úì Odesl√°no';
                    };
                } else {
                    btnPozvat.classList.add('hidden');
                }

                $('profil-loading').classList.add('hidden');
            } catch(e) {
                $('profil-loading').textContent = 'Chyba: ' + e.message;
            }
        };

    </script>
</body>
</html>
